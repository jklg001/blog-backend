# ä¾èµ–æ³¨å…¥åŸç†

> ä»å‰ç«¯çš„æ‰‹åŠ¨ä¾èµ–ç®¡ç†åˆ°åç«¯çš„è‡ªåŠ¨ä¾èµ–æ³¨å…¥

## ğŸ¤” ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ

### å‰ç«¯çš„ä¾èµ–ç®¡ç†é—®é¢˜

åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œä½ å¯èƒ½é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼š

```tsx
// âŒ é—®é¢˜ä»£ç ï¼šç»„ä»¶ç›´æ¥åˆ›å»ºä¾èµ–
function UserProfile({ userId }) {
  const apiClient = new ApiClient();  // ç¡¬ç¼–ç ä¾èµ–
  const userService = new UserService(apiClient);
  
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    userService.getUser(userId).then(setUser);
  }, [userId]);
  
  return <div>{user?.name}</div>;
}
```

**é—®é¢˜**ï¼š
- âŒ éš¾ä»¥æµ‹è¯•ï¼ˆæ— æ³•Mock ApiClientï¼‰
- âŒ é…ç½®æ··ä¹±ï¼ˆæ¯ä¸ªç»„ä»¶éƒ½è¦é…ç½®ï¼‰
- âŒ è€¦åˆåº¦é«˜ï¼ˆç»„ä»¶çŸ¥é“å¤ªå¤šå®ç°ç»†èŠ‚ï¼‰
- âŒ éš¾ä»¥æ›¿æ¢ï¼ˆæ¯”å¦‚è¦æ¢æˆä¸åŒçš„APIï¼‰

### å‰ç«¯çš„è§£å†³æ–¹æ¡ˆï¼šContext + Provider

```tsx
// âœ… å‰ç«¯çš„ä¾èµ–æ³¨å…¥æ–¹æ¡ˆ
const ServicesContext = createContext();

function ServicesProvider({ children }) {
  const apiClient = new ApiClient();
  const userService = new UserService(apiClient);
  
  return (
    <ServicesContext.Provider value={{ userService }}>
      {children}
    </ServicesContext.Provider>
  );
}

function UserProfile({ userId }) {
  const { userService } = useContext(ServicesContext);  // æ³¨å…¥ä¾èµ–
  
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    userService.getUser(userId).then(setUser);
  }, [userId]);
  
  return <div>{user?.name}</div>;
}
```

### åç«¯çš„è‡ªåŠ¨ä¾èµ–æ³¨å…¥

```typescript
// âœ… NestJSçš„è‡ªåŠ¨ä¾èµ–æ³¨å…¥
@Controller('users')
export class UserController {
  constructor(
    private userService: UserService  // è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
  ) {}
  
  @Get(':id')
  async findOne(@Param('id') id: string) {
    return this.userService.findOne(+id);
  }
}
```

## ğŸ” æ·±å…¥ç†è§£ä¾èµ–æ³¨å…¥

### 1. æ§åˆ¶åè½¬ (IoC) åŸç†

**ä¼ ç»Ÿæ–¹å¼**ï¼šå¯¹è±¡ä¸»åŠ¨åˆ›å»ºä¾èµ–
```typescript
class ArticleService {
  constructor() {
    this.userService = new UserService();  // ä¸»åŠ¨åˆ›å»º
    this.emailService = new EmailService(); // ä¸»åŠ¨åˆ›å»º
  }
}
```

**ä¾èµ–æ³¨å…¥**ï¼šå¤–éƒ¨å®¹å™¨æä¾›ä¾èµ–
```typescript
@Injectable()
export class ArticleService {
  constructor(
    private userService: UserService,     // è¢«åŠ¨æ¥æ”¶
    private emailService: EmailService,  // è¢«åŠ¨æ¥æ”¶
  ) {}
}
```

**å¯¹æ¯”å‰ç«¯çŠ¶æ€ç®¡ç†**ï¼š

| æ–¹å¼ | ä¼ ç»Ÿç»„ä»¶ | Contextæ–¹å¼ | åç«¯DI |
|------|---------|------------|--------|
| ä¾èµ–æ¥æº | ç»„ä»¶å†…åˆ›å»º | Contextæä¾› | å®¹å™¨æ³¨å…¥ |
| æ§åˆ¶æƒ | ç»„ä»¶æ§åˆ¶ | å¤–éƒ¨æ§åˆ¶ | æ¡†æ¶æ§åˆ¶ |
| æµ‹è¯•æ€§ | éš¾æµ‹è¯• | å¯Mock | æ˜“Mock |

### 2. ä¾èµ–æ³¨å…¥å®¹å™¨

**å‰ç«¯çš„"å®¹å™¨"æ¦‚å¿µ**ï¼š
```tsx
// Reactçš„Providerå°±åƒä¸€ä¸ªå®¹å™¨
function App() {
  return (
    <UserProvider>      {/* ç”¨æˆ·æœåŠ¡å®¹å™¨ */}
      <ThemeProvider>   {/* ä¸»é¢˜æœåŠ¡å®¹å™¨ */}
        <ApiProvider>   {/* APIæœåŠ¡å®¹å™¨ */}
          <Routes />
        </ApiProvider>
      </ThemeProvider>
    </UserProvider>
  );
}
```

**åç«¯çš„DIå®¹å™¨**ï¼š
```typescript
// NestJSè‡ªåŠ¨æ„å»ºä¾èµ–å›¾
@Module({
  providers: [
    UserService,           // æ³¨å†Œåˆ°å®¹å™¨
    EmailService,          // æ³¨å†Œåˆ°å®¹å™¨
    ArticleService,        // ä¾èµ–ä¸Šé¢ä¸¤ä¸ªæœåŠ¡
  ],
})
export class AppModule {}

// æ¡†æ¶è‡ªåŠ¨è§£æä¾èµ–å…³ç³»ï¼š
// ArticleService â†’ UserService + EmailService
```

## ğŸ—ï¸ NestJSçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

### 1. Provider çš„ç±»å‹

#### ç±»æä¾›è€…ï¼ˆæœ€å¸¸ç”¨ï¼‰
```typescript
@Module({
  providers: [UserService],  // ç®€å†™
  // ç­‰ä»·äºï¼š
  providers: [
    {
      provide: UserService,
      useClass: UserService,
    }
  ],
})
```

#### å€¼æä¾›è€…
```typescript
const CONFIG = {
  database: {
    host: 'localhost',
    port: 3306,
  }
};

@Module({
  providers: [
    {
      provide: 'CONFIG',
      useValue: CONFIG,
    }
  ],
})

// ä½¿ç”¨ï¼š
@Injectable()
export class UserService {
  constructor(
    @Inject('CONFIG') private config: any
  ) {}
}
```

**å‰ç«¯å¯¹æ¯”**ï¼š
```tsx
// å‰ç«¯çš„ç¯å¢ƒå˜é‡æ³¨å…¥
const ConfigContext = createContext();

function ConfigProvider({ children }) {
  const config = {
    apiUrl: process.env.REACT_APP_API_URL,
    version: process.env.REACT_APP_VERSION,
  };
  
  return (
    <ConfigContext.Provider value={config}>
      {children}
    </ConfigContext.Provider>
  );
}
```

#### å·¥å‚æä¾›è€…
```typescript
@Module({
  providers: [
    {
      provide: 'LOGGER',
      useFactory: (config: ConfigService) => {
        return new Logger(config.get('LOG_LEVEL'));
      },
      inject: [ConfigService],  // å·¥å‚å‡½æ•°çš„ä¾èµ–
    }
  ],
})
```

**å‰ç«¯å¯¹æ¯”**ï¼š
```tsx
// å‰ç«¯çš„å·¥å‚æ¨¡å¼
function createApiClient(config) {
  return new ApiClient({
    baseURL: config.apiUrl,
    timeout: config.timeout,
  });
}

function ApiProvider({ children }) {
  const config = useContext(ConfigContext);
  const apiClient = useMemo(() => createApiClient(config), [config]);
  
  return (
    <ApiContext.Provider value={apiClient}>
      {children}
    </ApiContext.Provider>
  );
}
```

### 2. ä½œç”¨åŸŸ (Scope)

#### å•ä¾‹æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```typescript
@Injectable()  // é»˜è®¤æ˜¯å•ä¾‹
export class UserService {
  private cache = new Map();  // ç¼“å­˜ä¼šåœ¨æ•´ä¸ªåº”ç”¨ä¸­å…±äº«
}
```

**å‰ç«¯å¯¹æ¯”**ï¼š
```tsx
// å…¨å±€çŠ¶æ€ï¼ˆå•ä¾‹ï¼‰
const GlobalStore = createStore();

function App() {
  return (
    <Provider store={GlobalStore}>  {/* æ•´ä¸ªåº”ç”¨å…±äº«ä¸€ä¸ªstore */}
      <Routes />
    </Provider>
  );
}
```

#### è¯·æ±‚ä½œç”¨åŸŸ
```typescript
@Injectable({ scope: Scope.REQUEST })
export class RequestService {
  private requestId = Math.random();  // æ¯ä¸ªè¯·æ±‚éƒ½æœ‰ç‹¬ç«‹çš„å®ä¾‹
}
```

**å‰ç«¯å¯¹æ¯”**ï¼š
```tsx
// æ¯ä¸ªé¡µé¢ç»„ä»¶æœ‰ç‹¬ç«‹çŠ¶æ€
function UserPage() {
  const [localState, setLocalState] = useState({});  // æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°çš„
  
  return <div>...</div>;
}
```

## ğŸ”§ å®æˆ˜ï¼šæˆ‘ä»¬é¡¹ç›®ä¸­çš„ä¾èµ–æ³¨å…¥

### æ–‡ç« æœåŠ¡çš„ä¾èµ–æ³¨å…¥

```typescript
// src/article/article.service.ts
@Injectable()
export class ArticleService {
  constructor(
    @InjectRepository(Article)           // æ³¨å…¥æ–‡ç« ä»“åº“
    private articleRepository: Repository<Article>,
    
    @InjectRepository(User)              // æ³¨å…¥ç”¨æˆ·ä»“åº“
    private userRepository: Repository<User>,
  ) {}
  
  async create(createArticleDto: CreateArticleDto, userId: number) {
    // éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    const user = await this.userRepository.findOne({ where: { id: userId } });
    if (!user) {
      throw new BadRequestException(`ç”¨æˆ·ID ${userId} ä¸å­˜åœ¨`);
    }
    
    // åˆ›å»ºæ–‡ç« é€»è¾‘...
  }
}
```

**ä¾èµ–æµç¨‹**ï¼š
1. **æ³¨å†Œé˜¶æ®µ**ï¼šArticleModule æ³¨å†Œ ArticleService
2. **è§£æé˜¶æ®µ**ï¼šæ¡†æ¶å‘ç° ArticleService éœ€è¦ä¸¤ä¸ª Repository
3. **åˆ›å»ºé˜¶æ®µ**ï¼šæ¡†æ¶è‡ªåŠ¨åˆ›å»º Repository å®ä¾‹å¹¶æ³¨å…¥
4. **ä½¿ç”¨é˜¶æ®µ**ï¼šArticleController è·å¾—é…ç½®å¥½çš„ ArticleService

### æ¨¡å—é—´çš„ä¾èµ–æ³¨å…¥

```typescript
// src/article/article.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([Article, User])  // å¯¼å…¥éœ€è¦çš„å®ä½“
  ],
  controllers: [ArticleController],
  providers: [ArticleService],
  exports: [ArticleService],                   // å¯¼å‡ºç»™å…¶ä»–æ¨¡å—ä½¿ç”¨
})
export class ArticleModule {}
```

**ç±»æ¯”å‰ç«¯æ¨¡å—**ï¼š
```tsx
// å‰ç«¯çš„æ¨¡å—å¯¼å‡º
export { UserService } from './UserService';
export { useUser } from './hooks/useUser';
export { UserContext } from './UserContext';

// å…¶ä»–æ¨¡å—å¯¼å…¥
import { UserService } from '@/modules/user';
```

## ğŸ§ª æµ‹è¯•ä¸­çš„ä¾èµ–æ³¨å…¥

### å‰ç«¯æµ‹è¯•çš„ Mock

```tsx
// å‰ç«¯æµ‹è¯•
const mockUserService = {
  getUser: jest.fn().mockResolvedValue({ id: 1, name: 'Test User' }),
};

render(
  <ServicesContext.Provider value={{ userService: mockUserService }}>
    <UserProfile userId={1} />
  </ServicesContext.Provider>
);
```

### åç«¯æµ‹è¯•çš„ Mock

```typescript
// åç«¯æµ‹è¯•
describe('ArticleService', () => {
  let service: ArticleService;
  let mockUserRepository: Repository<User>;
  
  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        ArticleService,
        {
          provide: getRepositoryToken(User),
          useValue: {
            findOne: jest.fn(),  // Mock æ–¹æ³•
          },
        },
      ],
    }).compile();
    
    service = module.get<ArticleService>(ArticleService);
    mockUserRepository = module.get(getRepositoryToken(User));
  });
  
  it('should validate user exists', async () => {
    mockUserRepository.findOne.mockResolvedValue(null);
    
    await expect(
      service.create(createArticleDto, 999)
    ).rejects.toThrow('ç”¨æˆ·ID 999 ä¸å­˜åœ¨');
  });
});
```

## ğŸŒŸ ä¾èµ–æ³¨å…¥çš„ä¼˜åŠ¿

### 1. æ¾è€¦åˆ
```typescript
// âŒ ç´§è€¦åˆ
class ArticleService {
  constructor() {
    this.emailService = new EmailService();  // ç›´æ¥ä¾èµ–å…·ä½“å®ç°
  }
}

// âœ… æ¾è€¦åˆ
class ArticleService {
  constructor(
    private emailService: EmailService  // ä¾èµ–æ¥å£ï¼Œå¯ä»¥æ›¿æ¢å®ç°
  ) {}
}
```

### 2. æ˜“æµ‹è¯•
```typescript
// æµ‹è¯•æ—¶å¯ä»¥è½»æ¾æ›¿æ¢ä¾èµ–
const mockEmailService = {
  send: jest.fn(),
};

const articleService = new ArticleService(mockEmailService);
```

### 3. é…ç½®é›†ä¸­
```typescript
// æ‰€æœ‰ä¾èµ–é…ç½®éƒ½åœ¨Moduleä¸­
@Module({
  providers: [
    ArticleService,
    EmailService,
    {
      provide: 'CONFIG',
      useValue: config,
    }
  ],
})
```

## ğŸ“ å­¦ä¹ è¦ç‚¹æ€»ç»“

1. **ä¾èµ–æ³¨å…¥ = è‡ªåŠ¨åŒ–çš„Context**ï¼šæ¡†æ¶å¸®ä½ ç®¡ç†ä¾èµ–çš„åˆ›å»ºå’Œæ³¨å…¥
2. **æ§åˆ¶åè½¬**ï¼šä»"æˆ‘è¦ä»€ä¹ˆæˆ‘è‡ªå·±åˆ›å»º"å˜æˆ"æˆ‘éœ€è¦ä»€ä¹ˆå¤–éƒ¨ç»™æˆ‘"
3. **Provider = æœåŠ¡å·¥å‚**ï¼šå‘Šè¯‰æ¡†æ¶å¦‚ä½•åˆ›å»ºå’Œé…ç½®æœåŠ¡
4. **ä½œç”¨åŸŸæ§åˆ¶**ï¼šç±»ä¼¼å‰ç«¯çš„çŠ¶æ€ä½œç”¨åŸŸï¼Œæ§åˆ¶å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ
5. **æµ‹è¯•å‹å¥½**ï¼šå¯ä»¥è½»æ¾æ›¿æ¢ä»»ä½•ä¾èµ–è¿›è¡Œå•å…ƒæµ‹è¯•

## ğŸ”— ä¸å‰ç«¯æ¦‚å¿µå¯¹åº”

| åç«¯DIæ¦‚å¿µ | å‰ç«¯å¯¹åº” | è¯´æ˜ |
|-----------|---------|------|
| @Injectable() | useContext Hook | å£°æ˜å¯è¢«æ³¨å…¥ |
| Provider | Context Provider | æä¾›ä¾èµ– |
| @Inject() | useContext() | è·å–ä¾èµ– |
| Module | Providerç»„åˆ | ç»„ç»‡ä¾èµ–å…³ç³» |
| Scope | Stateä½œç”¨åŸŸ | æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ |

ç†è§£äº†ä¾èµ–æ³¨å…¥ï¼Œä½ å°±æŒæ¡äº†ç°ä»£åç«¯æ¡†æ¶çš„æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼ 