# 🏗️ 第9.2节：系统架构设计

> **从需求到架构** - 企业级博客系统的架构设计实践

## 🎯 学习目标

通过本节学习，你将能够：

- 🏗️ **设计系统架构**：掌握企业级系统的整体架构设计方法
- 🗄️ **设计数据模型**：学会设计高效、可扩展的数据库架构
- 🔌 **设计API接口**：建立RESTful API的设计规范和最佳实践
- 🔒 **设计安全架构**：构建完整的安全防护体系

## 🏗️ 系统整体架构设计

### 📊 架构概览

#### 🏠 生活类比：现代化办公大楼

想象我们的博客系统就像一座现代化的办公大楼：

```
🏢 办公大楼（博客系统架构）
├── 🚪 大堂接待（API网关）
├── 🛗 电梯系统（负载均衡）
├── 🏢 办公楼层（应用服务）
├── 🗄️ 档案室（数据存储）
├── 🔌 电力系统（基础设施）
└── 🛡️ 安保系统（安全防护）

🎯 架构对应关系
├── 🚪 统一入口 → API网关
├── 🛗 流量分发 → 负载均衡
├── 🏢 业务处理 → 应用层
├── 🗄️ 数据管理 → 数据层
├── 🔌 基础支撑 → 基础设施
└── 🛡️ 安全防护 → 安全架构
```

#### 🎯 分层架构设计

```typescript
// 系统分层架构
interface SystemArchitecture {
  // 表现层 (Presentation Layer)
  presentationLayer: {
    webClient: {
      technology: 'React + Next.js';
      responsibilities: [
        '用户界面渲染',
        '用户交互处理',
        '状态管理',
        '路由管理'
      ];
      components: [
        'Pages',
        'Components',
        'Hooks',
        'Utils'
      ];
    };
    
    mobileClient: {
      technology: 'React Native / PWA';
      responsibilities: [
        '移动端界面',
        '离线支持',
        '推送通知',
        '原生功能集成'
      ];
    };
    
    adminPanel: {
      technology: 'React + Ant Design';
      responsibilities: [
        '管理界面',
        '数据可视化',
        '系统配置',
        '监控面板'
      ];
    };
  };
  
  // API网关层 (API Gateway Layer)
  apiGatewayLayer: {
    gateway: {
      technology: 'Kong / Nginx';
      responsibilities: [
        '请求路由',
        '负载均衡',
        '认证授权',
        '限流熔断',
        'API版本管理'
      ];
      features: [
        'Rate Limiting',
        'Authentication',
        'Request/Response Transformation',
        'Monitoring & Analytics',
        'Circuit Breaker'
      ];
    };
  };
  
  // 应用层 (Application Layer)
  applicationLayer: {
    userService: {
      responsibilities: [
        '用户管理',
        '认证授权',
        '用户资料',
        '权限控制'
      ];
      apis: [
        '/api/auth/*',
        '/api/users/*',
        '/api/profiles/*'
      ];
    };
    
    contentService: {
      responsibilities: [
        '内容管理',
        '文章发布',
        '分类标签',
        '内容审核'
      ];
      apis: [
        '/api/articles/*',
        '/api/categories/*',
        '/api/tags/*'
      ];
    };
    
    interactionService: {
      responsibilities: [
        '评论管理',
        '点赞收藏',
        '关注订阅',
        '社交功能'
      ];
      apis: [
        '/api/comments/*',
        '/api/likes/*',
        '/api/follows/*'
      ];
    };
    
    searchService: {
      responsibilities: [
        '全文搜索',
        '搜索建议',
        '搜索统计',
        '内容推荐'
      ];
      apis: [
        '/api/search/*',
        '/api/recommendations/*'
      ];
    };
  };
  
  // 数据层 (Data Layer)
  dataLayer: {
    primaryDatabase: {
      technology: 'PostgreSQL';
      purpose: '主要业务数据存储';
      schemas: ['users', 'articles', 'comments', 'interactions'];
    };
    
    cacheLayer: {
      technology: 'Redis';
      purpose: '缓存和会话存储';
      useCases: ['Session Storage', 'API Cache', 'Counter Cache'];
    };
    
    searchEngine: {
      technology: 'Elasticsearch';
      purpose: '全文搜索和分析';
      indices: ['articles', 'users', 'tags'];
    };
    
    fileStorage: {
      technology: 'MinIO / AWS S3';
      purpose: '文件和媒体存储';
      buckets: ['avatars', 'article-images', 'attachments'];
    };
  };
  
  // 基础设施层 (Infrastructure Layer)
  infrastructureLayer: {
    containerization: {
      technology: 'Docker + Docker Compose';
      purpose: '应用容器化和编排';
    };
    
    monitoring: {
      technology: 'Prometheus + Grafana';
      purpose: '系统监控和告警';
    };
    
    logging: {
      technology: 'ELK Stack';
      purpose: '日志收集和分析';
    };
    
    messageQueue: {
      technology: 'Redis / RabbitMQ';
      purpose: '异步消息处理';
    };
  };
}
```

### 🔄 服务间通信设计

```typescript
// 服务通信架构
interface ServiceCommunication {
  // 同步通信
  synchronousCommunication: {
    restApi: {
      protocol: 'HTTP/HTTPS';
      format: 'JSON';
      authentication: 'JWT Bearer Token';
      useCases: [
        '用户认证',
        '数据查询',
        '实时操作'
      ];
    };
    
    graphql: {
      protocol: 'HTTP/HTTPS';
      format: 'GraphQL';
      useCases: [
        '复杂数据查询',
        '客户端定制化',
        '减少网络请求'
      ];
    };
  };
  
  // 异步通信
  asynchronousCommunication: {
    eventDriven: {
      technology: 'Redis Pub/Sub';
      patterns: ['Event Sourcing', 'CQRS'];
      useCases: [
        '数据同步',
        '缓存更新',
        '通知发送'
      ];
    };
    
    messageQueue: {
      technology: 'Bull Queue (Redis)';
      patterns: ['Producer-Consumer', 'Work Queue'];
      useCases: [
        '邮件发送',
        '图片处理',
        '数据分析'
      ];
    };
  };
  
  // 数据一致性策略
  dataConsistency: {
    strongConsistency: {
      scope: '单个服务内部';
      mechanism: 'ACID事务';
      useCases: ['用户注册', '文章发布'];
    };
    
    eventualConsistency: {
      scope: '跨服务操作';
      mechanism: '事件驱动 + 补偿机制';
      useCases: ['搜索索引更新', '缓存同步'];
    };
  };
}
```

## 🗄️ 数据库设计和建模

### 📊 数据模型设计

```typescript
// 核心实体设计
interface DatabaseSchema {
  // 用户相关表
  userTables: {
    users: {
      description: '用户基本信息表';
      fields: {
        id: 'UUID PRIMARY KEY';
        username: 'VARCHAR(50) UNIQUE NOT NULL';
        email: 'VARCHAR(255) UNIQUE NOT NULL';
        password_hash: 'VARCHAR(255) NOT NULL';
        status: 'ENUM(active, inactive, banned)';
        email_verified: 'BOOLEAN DEFAULT FALSE';
        created_at: 'TIMESTAMP DEFAULT NOW()';
        updated_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_users_email',
        'idx_users_username',
        'idx_users_status'
      ];
    };
    
    user_profiles: {
      description: '用户详细资料表';
      fields: {
        user_id: 'UUID PRIMARY KEY REFERENCES users(id)';
        display_name: 'VARCHAR(100)';
        bio: 'TEXT';
        avatar_url: 'VARCHAR(500)';
        website: 'VARCHAR(255)';
        location: 'VARCHAR(100)';
        birth_date: 'DATE';
        gender: 'ENUM(male, female, other)';
        created_at: 'TIMESTAMP DEFAULT NOW()';
        updated_at: 'TIMESTAMP DEFAULT NOW()';
      };
    };
    
    user_roles: {
      description: '用户角色表';
      fields: {
        id: 'UUID PRIMARY KEY';
        name: 'VARCHAR(50) UNIQUE NOT NULL';
        description: 'TEXT';
        permissions: 'JSONB';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
    };
    
    user_role_assignments: {
      description: '用户角色分配表';
      fields: {
        user_id: 'UUID REFERENCES users(id)';
        role_id: 'UUID REFERENCES user_roles(id)';
        assigned_at: 'TIMESTAMP DEFAULT NOW()';
        assigned_by: 'UUID REFERENCES users(id)';
      };
      primaryKey: ['user_id', 'role_id'];
    };
  };
  
  // 内容相关表
  contentTables: {
    categories: {
      description: '文章分类表';
      fields: {
        id: 'UUID PRIMARY KEY';
        name: 'VARCHAR(100) UNIQUE NOT NULL';
        slug: 'VARCHAR(100) UNIQUE NOT NULL';
        description: 'TEXT';
        parent_id: 'UUID REFERENCES categories(id)';
        sort_order: 'INTEGER DEFAULT 0';
        is_active: 'BOOLEAN DEFAULT TRUE';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_categories_slug',
        'idx_categories_parent_id'
      ];
    };
    
    tags: {
      description: '标签表';
      fields: {
        id: 'UUID PRIMARY KEY';
        name: 'VARCHAR(50) UNIQUE NOT NULL';
        slug: 'VARCHAR(50) UNIQUE NOT NULL';
        description: 'TEXT';
        color: 'VARCHAR(7)'; // HEX color
        usage_count: 'INTEGER DEFAULT 0';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_tags_slug',
        'idx_tags_usage_count'
      ];
    };
    
    articles: {
      description: '文章表';
      fields: {
        id: 'UUID PRIMARY KEY';
        title: 'VARCHAR(255) NOT NULL';
        slug: 'VARCHAR(255) UNIQUE NOT NULL';
        summary: 'TEXT';
        content: 'TEXT NOT NULL';
        content_type: 'ENUM(markdown, html, rich_text)';
        author_id: 'UUID REFERENCES users(id) NOT NULL';
        category_id: 'UUID REFERENCES categories(id)';
        status: 'ENUM(draft, published, archived, deleted)';
        featured_image: 'VARCHAR(500)';
        reading_time: 'INTEGER'; // minutes
        view_count: 'INTEGER DEFAULT 0';
        like_count: 'INTEGER DEFAULT 0';
        comment_count: 'INTEGER DEFAULT 0';
        published_at: 'TIMESTAMP';
        created_at: 'TIMESTAMP DEFAULT NOW()';
        updated_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_articles_slug',
        'idx_articles_author_id',
        'idx_articles_category_id',
        'idx_articles_status',
        'idx_articles_published_at',
        'idx_articles_view_count',
        'idx_articles_like_count'
      ];
    };
    
    article_tags: {
      description: '文章标签关联表';
      fields: {
        article_id: 'UUID REFERENCES articles(id)';
        tag_id: 'UUID REFERENCES tags(id)';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      primaryKey: ['article_id', 'tag_id'];
      indexes: [
        'idx_article_tags_article_id',
        'idx_article_tags_tag_id'
      ];
    };
    
    article_revisions: {
      description: '文章版本历史表';
      fields: {
        id: 'UUID PRIMARY KEY';
        article_id: 'UUID REFERENCES articles(id) NOT NULL';
        title: 'VARCHAR(255) NOT NULL';
        content: 'TEXT NOT NULL';
        summary: 'TEXT';
        revision_number: 'INTEGER NOT NULL';
        change_summary: 'TEXT';
        created_by: 'UUID REFERENCES users(id) NOT NULL';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_article_revisions_article_id',
        'idx_article_revisions_revision_number'
      ];
    };
  };
  
  // 互动相关表
  interactionTables: {
    comments: {
      description: '评论表';
      fields: {
        id: 'UUID PRIMARY KEY';
        article_id: 'UUID REFERENCES articles(id) NOT NULL';
        author_id: 'UUID REFERENCES users(id) NOT NULL';
        parent_id: 'UUID REFERENCES comments(id)'; // 回复评论
        content: 'TEXT NOT NULL';
        status: 'ENUM(published, pending, spam, deleted)';
        like_count: 'INTEGER DEFAULT 0';
        reply_count: 'INTEGER DEFAULT 0';
        created_at: 'TIMESTAMP DEFAULT NOW()';
        updated_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_comments_article_id',
        'idx_comments_author_id',
        'idx_comments_parent_id',
        'idx_comments_status',
        'idx_comments_created_at'
      ];
    };
    
    likes: {
      description: '点赞表';
      fields: {
        id: 'UUID PRIMARY KEY';
        user_id: 'UUID REFERENCES users(id) NOT NULL';
        target_type: 'ENUM(article, comment)';
        target_id: 'UUID NOT NULL';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      uniqueConstraints: [
        'unique_user_target (user_id, target_type, target_id)'
      ];
      indexes: [
        'idx_likes_user_id',
        'idx_likes_target'
      ];
    };
    
    follows: {
      description: '关注关系表';
      fields: {
        id: 'UUID PRIMARY KEY';
        follower_id: 'UUID REFERENCES users(id) NOT NULL';
        following_id: 'UUID REFERENCES users(id) NOT NULL';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      uniqueConstraints: [
        'unique_follow (follower_id, following_id)'
      ];
      checkConstraints: [
        'follower_id != following_id'
      ];
      indexes: [
        'idx_follows_follower_id',
        'idx_follows_following_id'
      ];
    };
    
    bookmarks: {
      description: '收藏表';
      fields: {
        id: 'UUID PRIMARY KEY';
        user_id: 'UUID REFERENCES users(id) NOT NULL';
        article_id: 'UUID REFERENCES articles(id) NOT NULL';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      uniqueConstraints: [
        'unique_bookmark (user_id, article_id)'
      ];
      indexes: [
        'idx_bookmarks_user_id',
        'idx_bookmarks_article_id'
      ];
    };
  };
  
  // 系统相关表
  systemTables: {
    notifications: {
      description: '通知表';
      fields: {
        id: 'UUID PRIMARY KEY';
        user_id: 'UUID REFERENCES users(id) NOT NULL';
        type: 'ENUM(like, comment, follow, mention, system)';
        title: 'VARCHAR(255) NOT NULL';
        content: 'TEXT';
        data: 'JSONB'; // 额外数据
        is_read: 'BOOLEAN DEFAULT FALSE';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_notifications_user_id',
        'idx_notifications_type',
        'idx_notifications_is_read',
        'idx_notifications_created_at'
      ];
    };
    
    user_sessions: {
      description: '用户会话表';
      fields: {
        id: 'UUID PRIMARY KEY';
        user_id: 'UUID REFERENCES users(id) NOT NULL';
        token_hash: 'VARCHAR(255) NOT NULL';
        device_info: 'JSONB';
        ip_address: 'INET';
        user_agent: 'TEXT';
        expires_at: 'TIMESTAMP NOT NULL';
        created_at: 'TIMESTAMP DEFAULT NOW()';
        last_used_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_user_sessions_user_id',
        'idx_user_sessions_token_hash',
        'idx_user_sessions_expires_at'
      ];
    };
    
    audit_logs: {
      description: '审计日志表';
      fields: {
        id: 'UUID PRIMARY KEY';
        user_id: 'UUID REFERENCES users(id)';
        action: 'VARCHAR(100) NOT NULL';
        resource_type: 'VARCHAR(50)';
        resource_id: 'UUID';
        old_values: 'JSONB';
        new_values: 'JSONB';
        ip_address: 'INET';
        user_agent: 'TEXT';
        created_at: 'TIMESTAMP DEFAULT NOW()';
      };
      indexes: [
        'idx_audit_logs_user_id',
        'idx_audit_logs_action',
        'idx_audit_logs_resource',
        'idx_audit_logs_created_at'
      ];
    };
  };
}
```

### 🔄 数据库优化策略

```typescript
// 数据库性能优化
interface DatabaseOptimization {
  // 索引策略
  indexingStrategy: {
    primaryIndexes: {
      description: '主键和唯一索引';
      examples: [
        'users.id (PRIMARY KEY)',
        'users.email (UNIQUE)',
        'articles.slug (UNIQUE)'
      ];
    };
    
    queryIndexes: {
      description: '查询优化索引';
      examples: [
        'articles(author_id, status, published_at)',
        'comments(article_id, status, created_at)',
        'notifications(user_id, is_read, created_at)'
      ];
    };
    
    compositeIndexes: {
      description: '复合索引';
      examples: [
        'CREATE INDEX idx_articles_author_status ON articles(author_id, status)',
        'CREATE INDEX idx_comments_article_parent ON comments(article_id, parent_id)'
      ];
    };
    
    partialIndexes: {
      description: '部分索引';
      examples: [
        'CREATE INDEX idx_articles_published ON articles(published_at) WHERE status = \'published\'',
        'CREATE INDEX idx_notifications_unread ON notifications(user_id, created_at) WHERE is_read = FALSE'
      ];
    };
  };
  
  // 分区策略
  partitioningStrategy: {
    timeBasedPartitioning: {
      tables: ['audit_logs', 'notifications'];
      strategy: '按月分区';
      benefits: ['查询性能提升', '数据维护简化', '存储成本优化'];
    };
    
    hashPartitioning: {
      tables: ['user_sessions'];
      strategy: '按用户ID哈希分区';
      benefits: ['负载均衡', '并发性能提升'];
    };
  };
  
  // 缓存策略
  cachingStrategy: {
    queryCache: {
      technology: 'Redis';
      patterns: [
        '热门文章列表',
        '用户基本信息',
        '分类和标签数据'
      ];
      ttl: '15分钟 - 1小时';
    };
    
    applicationCache: {
      technology: 'Node.js Memory Cache';
      patterns: [
        '配置信息',
        '权限数据',
        '静态数据'
      ];
      ttl: '5分钟 - 30分钟';
    };
  };
  
  // 读写分离
  readWriteSeparation: {
    writeOperations: {
      target: 'Master Database';
      operations: ['INSERT', 'UPDATE', 'DELETE'];
    };
    
    readOperations: {
      target: 'Read Replicas';
      operations: ['SELECT'];
      loadBalancing: 'Round Robin';
    };
  };
}
```

## 🔌 API接口设计

### 📋 RESTful API设计规范

```typescript
// API设计规范
interface APIDesignStandards {
  // URL设计规范
  urlDesign: {
    resourceNaming: {
      principle: '使用名词复数形式';
      examples: [
        '/api/users',
        '/api/articles',
        '/api/comments'
      ];
    };
    
    hierarchicalStructure: {
      principle: '体现资源层次关系';
      examples: [
        '/api/articles/{id}/comments',
        '/api/users/{id}/articles',
        '/api/categories/{id}/articles'
      ];
    };
    
    queryParameters: {
      principle: '使用查询参数进行过滤和分页';
      examples: [
        '/api/articles?status=published&page=1&limit=20',
        '/api/users?role=author&sort=created_at&order=desc'
      ];
    };
  };
  
  // HTTP方法使用
  httpMethods: {
    GET: {
      purpose: '获取资源';
      idempotent: true;
      examples: [
        'GET /api/articles - 获取文章列表',
        'GET /api/articles/{id} - 获取特定文章'
      ];
    };
    
    POST: {
      purpose: '创建资源';
      idempotent: false;
      examples: [
        'POST /api/articles - 创建新文章',
        'POST /api/users/{id}/follow - 关注用户'
      ];
    };
    
    PUT: {
      purpose: '完整更新资源';
      idempotent: true;
      examples: [
        'PUT /api/articles/{id} - 完整更新文章',
        'PUT /api/users/{id}/profile - 更新用户资料'
      ];
    };
    
    PATCH: {
      purpose: '部分更新资源';
      idempotent: true;
      examples: [
        'PATCH /api/articles/{id} - 部分更新文章',
        'PATCH /api/users/{id}/status - 更新用户状态'
      ];
    };
    
    DELETE: {
      purpose: '删除资源';
      idempotent: true;
      examples: [
        'DELETE /api/articles/{id} - 删除文章',
        'DELETE /api/comments/{id} - 删除评论'
      ];
    };
  };
  
  // 状态码使用
  statusCodes: {
    success: {
      200: 'OK - 请求成功';
      201: 'Created - 资源创建成功';
      204: 'No Content - 请求成功但无返回内容';
    };
    
    clientError: {
      400: 'Bad Request - 请求参数错误';
      401: 'Unauthorized - 未认证';
      403: 'Forbidden - 无权限';
      404: 'Not Found - 资源不存在';
      409: 'Conflict - 资源冲突';
      422: 'Unprocessable Entity - 验证失败';
      429: 'Too Many Requests - 请求过于频繁';
    };
    
    serverError: {
      500: 'Internal Server Error - 服务器内部错误';
      502: 'Bad Gateway - 网关错误';
      503: 'Service Unavailable - 服务不可用';
    };
  };
}

// API接口定义
interface BlogAPIEndpoints {
  // 认证相关API
  authAPI: {
    'POST /api/auth/register': {
      description: '用户注册';
      requestBody: {
        username: 'string';
        email: 'string';
        password: 'string';
      };
      responses: {
        201: {
          user: 'UserDto';
          tokens: 'TokensDto';
        };
        400: 'ValidationErrorDto';
        409: 'ConflictErrorDto';
      };
    };
    
    'POST /api/auth/login': {
      description: '用户登录';
      requestBody: {
        email: 'string';
        password: 'string';
      };
      responses: {
        200: {
          user: 'UserDto';
          tokens: 'TokensDto';
        };
        401: 'UnauthorizedErrorDto';
      };
    };
    
    'POST /api/auth/refresh': {
      description: '刷新令牌';
      requestBody: {
        refreshToken: 'string';
      };
      responses: {
        200: 'TokensDto';
        401: 'UnauthorizedErrorDto';
      };
    };
    
    'POST /api/auth/logout': {
      description: '用户登出';
      headers: {
        Authorization: 'Bearer {token}';
      };
      responses: {
        204: 'No Content';
      };
    };
  };
  
  // 用户相关API
  userAPI: {
    'GET /api/users': {
      description: '获取用户列表';
      queryParameters: {
        page?: 'number';
        limit?: 'number';
        role?: 'string';
        status?: 'string';
        search?: 'string';
      };
      responses: {
        200: {
          data: 'UserDto[]';
          pagination: 'PaginationDto';
        };
      };
    };
    
    'GET /api/users/{id}': {
      description: '获取用户详情';
      parameters: {
        id: 'string (UUID)';
      };
      responses: {
        200: 'UserDetailDto';
        404: 'NotFoundErrorDto';
      };
    };
    
    'PUT /api/users/{id}/profile': {
      description: '更新用户资料';
      parameters: {
        id: 'string (UUID)';
      };
      headers: {
        Authorization: 'Bearer {token}';
      };
      requestBody: 'UpdateProfileDto';
      responses: {
        200: 'UserProfileDto';
        403: 'ForbiddenErrorDto';
        422: 'ValidationErrorDto';
      };
    };
  };
  
  // 文章相关API
  articleAPI: {
    'GET /api/articles': {
      description: '获取文章列表';
      queryParameters: {
        page?: 'number';
        limit?: 'number';
        status?: 'published | draft | archived';
        category?: 'string';
        tag?: 'string';
        author?: 'string';
        search?: 'string';
        sort?: 'created_at | updated_at | view_count | like_count';
        order?: 'asc | desc';
      };
      responses: {
        200: {
          data: 'ArticleListItemDto[]';
          pagination: 'PaginationDto';
          filters: 'FilterOptionsDto';
        };
      };
    };
    
    'GET /api/articles/{slug}': {
      description: '获取文章详情';
      parameters: {
        slug: 'string';
      };
      responses: {
        200: 'ArticleDetailDto';
        404: 'NotFoundErrorDto';
      };
    };
    
    'POST /api/articles': {
      description: '创建文章';
      headers: {
        Authorization: 'Bearer {token}';
      };
      requestBody: 'CreateArticleDto';
      responses: {
        201: 'ArticleDto';
        422: 'ValidationErrorDto';
      };
    };
    
    'PUT /api/articles/{id}': {
      description: '更新文章';
      parameters: {
        id: 'string (UUID)';
      };
      headers: {
        Authorization: 'Bearer {token}';
      };
      requestBody: 'UpdateArticleDto';
      responses: {
        200: 'ArticleDto';
        403: 'ForbiddenErrorDto';
        404: 'NotFoundErrorDto';
        422: 'ValidationErrorDto';
      };
    };
    
    'DELETE /api/articles/{id}': {
      description: '删除文章';
      parameters: {
        id: 'string (UUID)';
      };
      headers: {
        Authorization: 'Bearer {token}';
      };
      responses: {
        204: 'No Content';
        403: 'ForbiddenErrorDto';
        404: 'NotFoundErrorDto';
      };
    };
  };
  
  // 评论相关API
  commentAPI: {
    'GET /api/articles/{articleId}/comments': {
      description: '获取文章评论';
      parameters: {
        articleId: 'string (UUID)';
      };
      queryParameters: {
        page?: 'number';
        limit?: 'number';
        sort?: 'created_at | like_count';
        order?: 'asc | desc';
      };
      responses: {
        200: {
          data: 'CommentDto[]';
          pagination: 'PaginationDto';
        };
      };
    };
    
    'POST /api/articles/{articleId}/comments': {
      description: '创建评论';
      parameters: {
        articleId: 'string (UUID)';
      };
      headers: {
        Authorization: 'Bearer {token}';
      };
      requestBody: 'CreateCommentDto';
      responses: {
        201: 'CommentDto';
        422: 'ValidationErrorDto';
      };
    };
  };
}
```

### 📊 API文档和版本管理

```typescript
// API文档规范
interface APIDocumentation {
  // OpenAPI规范
  openAPISpec: {
    version: '3.0.0';
    info: {
      title: 'Blog System API';
      version: '1.0.0';
      description: '企业级博客系统API文档';
      contact: {
        name: 'API Support';
        email: 'api-support@blog.com';
      };
    };
    
    servers: [
      {
        url: 'https://api.blog.com/v1';
        description: '生产环境';
      },
      {
        url: 'https://staging-api.blog.com/v1';
        description: '测试环境';
      }
    ];
    
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http';
          scheme: 'bearer';
          bearerFormat: 'JWT';
        };
      };
    };
  };
  
  // 版本管理策略
  versioningStrategy: {
    approach: 'URL Path Versioning';
    format: '/api/v{major}/';
    examples: [
      '/api/v1/articles',
      '/api/v2/articles'
    ];
    
    deprecationPolicy: {
      supportPeriod: '12个月';
      notificationPeriod: '6个月提前通知';
      migrationGuide: '提供详细的迁移指南';
    };
    
    backwardCompatibility: {
      minorVersions: '向后兼容';
      majorVersions: '可能包含破坏性变更';
      deprecatedFields: '标记为deprecated但继续支持';
    };
  };
  
  // 错误处理规范
  errorHandling: {
    errorFormat: {
      error: {
        code: 'string'; // 错误代码
        message: 'string'; // 错误消息
        details?: 'object'; // 详细信息
        timestamp: 'string'; // 时间戳
        path: 'string'; // 请求路径
        traceId: 'string'; // 追踪ID
      };
    };
    
    validationErrors: {
      format: {
        error: {
          code: 'VALIDATION_ERROR';
          message: '请求参数验证失败';
          details: {
            field: 'string'; // 字段名
            value: 'any'; // 字段值
            message: 'string'; // 错误消息
          }[];
        };
      };
    };
  };
}
```

## 🔒 安全架构设计

### 🛡️ 认证和授权体系

```typescript
// 安全架构设计
interface SecurityArchitecture {
  // 认证机制
  authentication: {
    jwtAuthentication: {
      accessToken: {
        algorithm: 'RS256';
        expiration: '15分钟';
        payload: {
          sub: 'user_id';
          email: 'user_email';
          roles: 'user_roles[]';
          permissions: 'user_permissions[]';
          iat: 'issued_at';
          exp: 'expires_at';
        };
      };
      
      refreshToken: {
        algorithm: 'HS256';
        expiration: '7天';
        storage: 'Redis';
        rotation: '每次使用后更新';
      };
      
      tokenValidation: {
        signatureVerification: '验证JWT签名';
        expirationCheck: '检查令牌过期时间';
        blacklistCheck: '检查令牌黑名单';
        issuerValidation: '验证令牌颁发者';
      };
    };
    
    multiFactorAuthentication: {
      smsVerification: {
        provider: '阿里云短信服务';
        codeLength: 6;
        expiration: '5分钟';
        rateLimit: '每分钟1次';
      };
      
      emailVerification: {
        tokenLength: 32;
        expiration: '24小时';
        template: '邮箱验证模板';
      };
      
      totpAuthentication: {
        algorithm: 'SHA1';
        digits: 6;
        period: 30;
        window: 1;
      };
    };
  };
  
  // 授权机制
  authorization: {
    rbacModel: {
      description: '基于角色的访问控制';
      components: {
        users: '用户';
        roles: '角色';
        permissions: '权限';
        resources: '资源';
      };
      
      roles: [
        {
          name: 'admin';
          description: '系统管理员';
          permissions: ['*']; // 所有权限
        },
        {
          name: 'editor';
          description: '编辑';
          permissions: [
            'article:read',
            'article:write',
            'article:edit',
            'article:delete',
            'comment:moderate'
          ];
        },
        {
          name: 'author';
          description: '作者';
          permissions: [
            'article:read',
            'article:write',
            'article:edit:own',
            'comment:read',
            'comment:write'
          ];
        },
        {
          name: 'reader';
          description: '读者';
          permissions: [
            'article:read',
            'comment:read',
            'comment:write'
          ];
        }
      ];
    };
    
    permissionCheck: {
      resourceLevel: '资源级权限检查';
      actionLevel: '操作级权限检查';
      ownershipCheck: '所有权检查';
      contextualPermissions: '上下文相关权限';
    };
  };
  
  // 数据安全
  dataSecurity: {
    encryption: {
      atRest: {
        database: 'AES-256加密';
        files: 'AES-256加密';
        backups: 'AES-256加密';
      };
      
      inTransit: {
        https: 'TLS 1.3';
        databaseConnection: 'SSL/TLS';
        internalServices: 'mTLS';
      };
      
      applicationLevel: {
        passwords: 'bcrypt哈希';
        sensitiveData: 'AES-256加密';
        tokens: 'HMAC签名';
      };
    };
    
    dataPrivacy: {
      personalDataHandling: {
        collection: '最小化收集原则';
        processing: '合法性基础';
        storage: '有限期存储';
        deletion: '用户删除权';
      };
      
      gdprCompliance: {
        dataPortability: '数据可移植性';
        rightToErasure: '被遗忘权';
        dataMinimization: '数据最小化';
        consentManagement: '同意管理';
      };
    };
  };
  
  // 安全防护
  securityProtection: {
    inputValidation: {
      sqlInjectionPrevention: '参数化查询';
      xssPrevention: '输入过滤和输出编码';
      csrfProtection: 'CSRF令牌验证';
      commandInjectionPrevention: '输入验证';
    };
    
    rateLimiting: {
      globalRateLimit: '全局请求限制';
      userRateLimit: '用户请求限制';
      endpointRateLimit: '端点请求限制';
      ipRateLimit: 'IP请求限制';
    };
    
    securityHeaders: {
      contentSecurityPolicy: 'CSP策略';
      strictTransportSecurity: 'HSTS';
      xFrameOptions: 'X-Frame-Options';
      xContentTypeOptions: 'X-Content-Type-Options';
    };
    
    monitoring: {
      securityEvents: '安全事件监控';
      anomalyDetection: '异常检测';
      threatIntelligence: '威胁情报';
      incidentResponse: '事件响应';
    };
  };
}
```

## 📊 学习总结

通过本节学习，我们完成了：

1. **系统架构设计**：建立了分层的、可扩展的系统架构
2. **数据库设计**：设计了完整的数据模型和优化策略
3. **API接口设计**：制定了RESTful API的设计规范
4. **安全架构设计**：构建了完整的安全防护体系

这些设计为后续的开发实现提供了清晰的技术蓝图。

## 🎯 下一步

在下一节（第9.3节）中，我们将基于这些架构设计，搭建完整的开发环境，包括：
- 🛠️ 开发环境配置
- 📦 项目脚手架搭建
- 🔧 开发工具链配置
- 📏 代码规范和质量工具

让我们继续这个精彩的实战项目！ 🚀 