# ç¬¬2ç«  NestJSæ¨¡å—ç³»ç»Ÿè¯¦è§£

> **æ¨¡å—åŒ–è®¾è®¡çš„è‰ºæœ¯** - ä»ç»„ä»¶åŒ–æ€ç»´åˆ°ä¼ä¸šçº§æ¨¡å—æ¶æ„

## ğŸ“š æœ¬ç« å­¦ä¹ ç›®æ ‡

### ğŸ¯ çŸ¥è¯†ç›®æ ‡
- [ ] **æ¨¡å—åŒ–è®¾è®¡ç†å¿µ**ï¼šæ·±å…¥ç†è§£NestJSæ¨¡å—ç³»ç»Ÿçš„è®¾è®¡å“²å­¦å’Œæ¶æ„æ€æƒ³
- [ ] **ç»„ä»¶é€šä¿¡æœºåˆ¶**ï¼šæŒæ¡æ¨¡å—é—´ã€ç»„ä»¶é—´çš„é€šä¿¡æ–¹å¼å’Œæœ€ä½³å®è·µ
- [ ] **ä¾èµ–ç®¡ç†ç­–ç•¥**ï¼šå­¦ä¼šç®¡ç†å¤æ‚çš„æ¨¡å—ä¾èµ–å…³ç³»å’Œæ³¨å…¥æœºåˆ¶
- [ ] **æ¨¡å—é…ç½®ç®¡ç†**ï¼šæŒæ¡æ¨¡å—çš„é…ç½®ã€ç»„ç»‡å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

### ğŸ› ï¸ æŠ€èƒ½ç›®æ ‡
- [ ] èƒ½å¤Ÿè®¾è®¡åˆç†çš„æ¨¡å—æ¶æ„å’Œå±‚æ¬¡å…³ç³»
- [ ] èƒ½å¤Ÿå®ç°é«˜æ•ˆçš„æ¨¡å—é—´é€šä¿¡å’Œæ•°æ®æµè½¬
- [ ] èƒ½å¤Ÿå¤„ç†å¤æ‚çš„ä¾èµ–å…³ç³»å’Œå¾ªç¯ä¾èµ–é—®é¢˜
- [ ] èƒ½å¤Ÿä¼˜åŒ–æ¨¡å—æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§

### â° å­¦ä¹ æ—¶é•¿
- **æ¨¡å—æ€ç»´å»ºç«‹**ï¼š2-3å°æ—¶
- **ä¾èµ–å…³ç³»æŒæ¡**ï¼š2-3å°æ—¶  
- **é…ç½®ç®¡ç†å®è·µ**ï¼š2-3å°æ—¶
- **é€šä¿¡æœºåˆ¶åº”ç”¨**ï¼š2-3å°æ—¶
- **æ€»è®¡æ—¶é•¿**ï¼š8-12å°æ—¶

### ğŸ“‹ å‰ç½®çŸ¥è¯†æ£€æŸ¥
åœ¨å¼€å§‹æœ¬ç« å­¦ä¹ å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²æŒæ¡ä»¥ä¸‹çŸ¥è¯†ï¼š
- [ ] ç¬¬1ç« ï¼šåç«¯æ¶æ„æ€ç»´å¯¼å¼•ï¼ˆå¿…é¡»å®Œæˆï¼‰
- [ ] TypeScriptåŸºç¡€å’Œè£…é¥°å™¨æ¦‚å¿µï¼ˆå‰ç½®çŸ¥è¯†ï¼‰
- [ ] é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å—åŒ–æ€æƒ³
- [ ] ä¾èµ–æ³¨å…¥çš„åŸºæœ¬æ¦‚å¿µ

---

## ğŸ§© 2.1 æ¨¡å—æ€ç»´ï¼šç†è§£æ¨¡å—åŒ–çš„è®¾è®¡ç†å¿µ

### ğŸ’¡ æ ¸å¿ƒæ€æƒ³ï¼šæ¨¡å—æ˜¯è½¯ä»¶æ¶æ„çš„"ä¹é«˜ç§¯æœ¨"

> **é€šä¿—ç†è§£**ï¼šå¦‚æœæŠŠè½¯ä»¶ç³»ç»Ÿæ¯”ä½œä¸€åº§åŸå¸‚ï¼Œé‚£ä¹ˆæ¨¡å—å°±åƒåŸå¸‚ä¸­çš„ä¸åŒåŠŸèƒ½åŒºåŸŸï¼ˆå•†ä¸šåŒºã€ä½å®…åŒºã€å·¥ä¸šåŒºï¼‰ã€‚æ¯ä¸ªåŒºåŸŸæœ‰æ˜ç¡®çš„èŒè´£ï¼Œé€šè¿‡é“è·¯ï¼ˆæ¥å£ï¼‰ç›¸äº’è¿æ¥ï¼Œæ—¢ä¿æŒç‹¬ç«‹åˆååŒå·¥ä½œã€‚

### ğŸŒ ç°å®åº”ç”¨åœºæ™¯

1. **å¾®ä¿¡ç”Ÿæ€ç³»ç»Ÿ**ï¼šæœ‹å‹åœˆã€æ”¯ä»˜ã€å°ç¨‹åºç­‰æ¨¡å—
   - æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹å¼€å‘å’Œç»´æŠ¤
   - æ¨¡å—é—´é€šè¿‡ç»Ÿä¸€çš„æ¥å£é€šä¿¡
   - ç”¨æˆ·æ•°æ®åœ¨æ¨¡å—é—´å®‰å…¨å…±äº«

2. **æ·˜å®ç”µå•†å¹³å°**ï¼šç”¨æˆ·ã€å•†å“ã€è®¢å•ã€æ”¯ä»˜æ¨¡å—
   - æ¨¡å—åŒ–æ”¯æ’‘æµ·é‡ç”¨æˆ·å’Œäº¤æ˜“
   - ä¸åŒå›¢é˜Ÿè´Ÿè´£ä¸åŒæ¨¡å—
   - æ¨¡å—å¯ä»¥ç‹¬ç«‹å‡çº§å’Œæ‰©å±•

3. **ä¼ä¸šERPç³»ç»Ÿ**ï¼šè´¢åŠ¡ã€äººäº‹ã€åº“å­˜ã€é”€å”®æ¨¡å—
   - ä¸šåŠ¡æ¨¡å—å¯¹åº”ç»„ç»‡æ¶æ„
   - æ•°æ®åœ¨æ¨¡å—é—´æœ‰åºæµè½¬
   - æƒé™æ§åˆ¶ç²¾ç¡®åˆ°æ¨¡å—çº§åˆ«

### 2.1.1 NestJSæ¨¡å—ç³»ç»Ÿæ¶æ„å›¾è§£

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚ Application Layer"
        A[AppModule æ ¹æ¨¡å—]
    end
    
    subgraph "ä¸šåŠ¡å±‚ Business Layer"
        B[UserModule ç”¨æˆ·æ¨¡å—]
        C[ArticleModule æ–‡ç« æ¨¡å—]
        D[CommentModule è¯„è®ºæ¨¡å—]
        E[AuthModule è®¤è¯æ¨¡å—]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚ Infrastructure Layer"
        F[DatabaseModule æ•°æ®åº“æ¨¡å—]
        G[ConfigModule é…ç½®æ¨¡å—]
        H[LoggerModule æ—¥å¿—æ¨¡å—]
        I[CacheModule ç¼“å­˜æ¨¡å—]
    end
    
    A --> B
    A --> C
    A --> D
    A --> E
    
    B --> F
    B --> G
    C --> F
    C --> H
    D --> F
    E --> G
    E --> I
    
    style A fill:#ff6b6b
    style B fill:#4ecdc4
    style C fill:#4ecdc4
    style D fill:#4ecdc4
    style E fill:#4ecdc4
    style F fill:#ffe66d
    style G fill:#ffe66d
    style H fill:#ffe66d
    style I fill:#ffe66d
```

### 2.1.2 æ¨¡å—åŒ–è®¾è®¡çš„æ ¸å¿ƒåŸåˆ™

#### ğŸ¯ å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰åœ¨æ¨¡å—ä¸­çš„åº”ç”¨

> **ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒå¨æˆ¿é‡Œçš„ä¸åŒå·¥å…·ï¼Œåˆ€ç”¨æ¥åˆ‡èœï¼Œé”…ç”¨æ¥ç‚’èœï¼Œæ¯ä¸ªå·¥å…·éƒ½æœ‰æ˜ç¡®çš„èŒè´£ã€‚æ¨¡å—ä¹Ÿåº”è¯¥æœ‰æ˜ç¡®çš„ä¸šåŠ¡è¾¹ç•Œã€‚

```typescript
// ğŸ¯ æ€æƒ³è§£è¯»ï¼šæ¨¡å—èŒè´£åˆ’åˆ†çš„è‰ºæœ¯
// é—®é¢˜ï¼šå¦‚ä½•ç¡®å®šæ¨¡å—çš„è¾¹ç•Œå’ŒèŒè´£ï¼Ÿ
// è§£å†³ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸå’Œæ•°æ®èšåˆæ ¹åˆ’åˆ†æ¨¡å—

// âœ… æ­£ç¡®çš„æ¨¡å—èŒè´£åˆ’åˆ†
@Module({
  // ç”¨æˆ·æ¨¡å—ï¼šåªè´Ÿè´£ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
  providers: [
    UserService,        // ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
    UserRepository,     // ç”¨æˆ·æ•°æ®è®¿é—®
    UserValidator,      // ç”¨æˆ·æ•°æ®éªŒè¯
    UserTransformer,    // ç”¨æˆ·æ•°æ®è½¬æ¢
  ],
  controllers: [UserController],
  exports: [UserService], // åªå¯¼å‡ºæ ¸å¿ƒæœåŠ¡
})
export class UserModule {}

@Module({
  // æ–‡ç« æ¨¡å—ï¼šåªè´Ÿè´£æ–‡ç« ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
  providers: [
    ArticleService,
    ArticleRepository,
    ArticleSearchService,
    ArticleStatisticsService,
  ],
  controllers: [ArticleController],
  exports: [ArticleService],
})
export class ArticleModule {}

// âŒ é”™è¯¯çš„æ¨¡å—è®¾è®¡ï¼šèŒè´£æ··ä¹±
@Module({
  providers: [
    UserService,
    ArticleService,     // ä¸åº”è¯¥åœ¨ç”¨æˆ·æ¨¡å—ä¸­
    EmailService,       // åº”è¯¥åœ¨é€šä¿¡æ¨¡å—ä¸­
    PaymentService,     // åº”è¯¥åœ¨æ”¯ä»˜æ¨¡å—ä¸­
  ],
})
export class BadUserModule {} // è¿åå•ä¸€èŒè´£åŸåˆ™
```

#### ğŸ”— æ¨¡å—é—´çš„ä¾èµ–å…³ç³»è®¾è®¡

> **å»ºç­‘ç±»æ¯”**ï¼šæ¨¡å—é—´çš„ä¾èµ–å°±åƒå»ºç­‘çš„åœ°åŸºå’Œæ¥¼å±‚å…³ç³»ã€‚åœ°åŸºæ¨¡å—ï¼ˆåŸºç¡€è®¾æ–½ï¼‰æ”¯æ’‘ä¸šåŠ¡æ¨¡å—ï¼Œä¸šåŠ¡æ¨¡å—ä¹‹é—´ä¿æŒæ¾è€¦åˆã€‚

```typescript
// ğŸŒŸ ç°å®åº”ç”¨åœºæ™¯ï¼šåšå®¢ç³»ç»Ÿçš„æ¨¡å—ä¾èµ–è®¾è®¡

// åŸºç¡€è®¾æ–½æ¨¡å—ï¼šä¸ºå…¶ä»–æ¨¡å—æä¾›åŸºç¡€æœåŠ¡
@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: 'postgres',
      host: 'localhost',
      port: 5432,
      database: 'blog',
    }),
  ],
  exports: [TypeOrmModule], // å¯¼å‡ºæ•°æ®åº“è¿æ¥
})
export class DatabaseModule {}

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true, // å…¨å±€é…ç½®æ¨¡å—
    }),
  ],
  exports: [ConfigModule],
})
export class CoreConfigModule {}

// ä¸šåŠ¡æ¨¡å—ï¼šå®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘
@Module({
  imports: [
    DatabaseModule,           // ä¾èµ–æ•°æ®åº“æ¨¡å—
    TypeOrmModule.forFeature([User]), // æ³¨å†Œç”¨æˆ·å®ä½“
  ],
  providers: [UserService, UserRepository],
  controllers: [UserController],
  exports: [UserService],     // å¯¼å‡ºæœåŠ¡ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
})
export class UserModule {}

@Module({
  imports: [
    DatabaseModule,           // ä¾èµ–æ•°æ®åº“æ¨¡å—
    UserModule,              // ä¾èµ–ç”¨æˆ·æ¨¡å—ï¼ˆè·å–ä½œè€…ä¿¡æ¯ï¼‰
    TypeOrmModule.forFeature([Article]),
  ],
  providers: [ArticleService, ArticleRepository],
  controllers: [ArticleController],
  exports: [ArticleService],
})
export class ArticleModule {}

@Module({
  imports: [
    UserModule,              // éœ€è¦éªŒè¯ç”¨æˆ·èº«ä»½
    ArticleModule,           // éœ€è¦å…³è”æ–‡ç« 
    TypeOrmModule.forFeature([Comment]),
  ],
  providers: [CommentService],
  controllers: [CommentController],
  exports: [CommentService],
})
export class CommentModule {}

// åº”ç”¨æ ¹æ¨¡å—ï¼šç»„è£…æ‰€æœ‰æ¨¡å—
@Module({
  imports: [
    CoreConfigModule,        // å…¨å±€é…ç½®
    DatabaseModule,          // æ•°æ®åº“è¿æ¥
    UserModule,              // ç”¨æˆ·åŠŸèƒ½
    ArticleModule,           // æ–‡ç« åŠŸèƒ½
    CommentModule,           // è¯„è®ºåŠŸèƒ½
  ],
})
export class AppModule {}
```

#### ğŸ§  è®°å¿†æŠ€å·§å’Œæœ€ä½³å®è·µ

**æ¨¡å—è®¾è®¡çš„"SOLID"åŸåˆ™**ï¼š
- **S**ingle Responsibilityï¼šä¸€ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
- **O**pen/Closedï¼šæ¨¡å—å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **L**iskov Substitutionï¼šæ¨¡å—å¯ä»¥è¢«å…¶å®ç°æ›¿æ¢
- **I**nterface Segregationï¼šæ¨¡å—æ¥å£åº”è¯¥ç²¾ç®€å’Œä¸“ä¸€
- **D**ependency Inversionï¼šæ¨¡å—åº”è¯¥ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

**è®°å¿†å£è¯€**ï¼š
> "æ¨¡å—èŒè´£è¦å•ä¸€ï¼Œä¾èµ–å…³ç³»è¦æ¸…æ™°ï¼Œæ¥å£è®¾è®¡è¦ç®€æ´ï¼Œæ‰©å±•ä¿®æ”¹è¦å®¹æ˜“"

### 2.1.3 æ¨¡å—çš„ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨åŸŸ

#### ğŸ”„ æ¨¡å—ç”Ÿå‘½å‘¨æœŸç®¡ç†

```typescript
// ğŸ¯ æ€æƒ³è§£è¯»ï¼šæ¨¡å—ç”Ÿå‘½å‘¨æœŸçš„é‡è¦æ€§
// é—®é¢˜ï¼šå¦‚ä½•ç®¡ç†æ¨¡å—çš„åˆå§‹åŒ–ã€è¿è¡Œå’Œé”€æ¯ï¼Ÿ
// è§£å†³ï¼šé€šè¿‡ç”Ÿå‘½å‘¨æœŸé’©å­å’Œä½œç”¨åŸŸæ§åˆ¶

@Module({
  providers: [
    {
      provide: 'DATABASE_CONNECTION',
      useFactory: async (configService: ConfigService) => {
        // æ¨¡å—åˆå§‹åŒ–æ—¶å»ºç«‹æ•°æ®åº“è¿æ¥
        const connection = await createConnection({
          type: 'postgres',
          host: configService.get('DB_HOST'),
          port: configService.get('DB_PORT'),
          database: configService.get('DB_NAME'),
        });
        
        console.log('ğŸ“Š æ•°æ®åº“è¿æ¥å·²å»ºç«‹');
        return connection;
      },
      inject: [ConfigService],
    },
    {
      provide: UserService,
      useClass: UserService,
      scope: Scope.REQUEST, // è¯·æ±‚ä½œç”¨åŸŸï¼šæ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°å®ä¾‹
    },
    {
      provide: CacheService,
      useClass: CacheService,
      scope: Scope.DEFAULT, // é»˜è®¤ä½œç”¨åŸŸï¼šå•ä¾‹æ¨¡å¼
    },
  ],
})
export class UserModule implements OnModuleInit, OnModuleDestroy {
  
  // æ¨¡å—åˆå§‹åŒ–é’©å­
  async onModuleInit() {
    console.log('ğŸš€ UserModule åˆå§‹åŒ–å®Œæˆ');
    // æ‰§è¡Œæ¨¡å—åˆå§‹åŒ–é€»è¾‘
    await this.initializeUserData();
  }
  
  // æ¨¡å—é”€æ¯é’©å­
  async onModuleDestroy() {
    console.log('ğŸ”š UserModule æ­£åœ¨é”€æ¯');
    // æ‰§è¡Œæ¸…ç†é€»è¾‘
    await this.cleanupResources();
  }
  
  private async initializeUserData() {
    // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®ï¼Œå¦‚åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
  }
  
  private async cleanupResources() {
    // æ¸…ç†èµ„æºï¼Œå¦‚å…³é—­æ•°æ®åº“è¿æ¥
  }
}
```

#### ğŸ“Š æ¨¡å—ä½œç”¨åŸŸå¯¹æ¯”

| ä½œç”¨åŸŸç±»å‹ | ç”Ÿå‘½å‘¨æœŸ | ä½¿ç”¨åœºæ™¯ | æ€§èƒ½å½±å“ | å†…å­˜å ç”¨ |
|------------|----------|----------|----------|----------|
| **DEFAULT** | åº”ç”¨å¯åŠ¨åˆ°ç»“æŸ | æ— çŠ¶æ€æœåŠ¡ã€å·¥å…·ç±» | æœ€ä½³ | ä½ |
| **REQUEST** | å•ä¸ªè¯·æ±‚æœŸé—´ | éœ€è¦è¯·æ±‚ä¸Šä¸‹æ–‡çš„æœåŠ¡ | ä¸­ç­‰ | ä¸­ç­‰ |
| **TRANSIENT** | æ¯æ¬¡æ³¨å…¥æ—¶åˆ›å»º | æœ‰çŠ¶æ€çš„ä¸´æ—¶å¯¹è±¡ | è¾ƒå·® | é«˜ |

```typescript
// ğŸŒŸ ç°å®åº”ç”¨åœºæ™¯ï¼šä¸åŒä½œç”¨åŸŸçš„ä½¿ç”¨ç¤ºä¾‹

// é»˜è®¤ä½œç”¨åŸŸï¼šé…ç½®æœåŠ¡ï¼ˆå…¨å±€å•ä¾‹ï¼‰
@Injectable({ scope: Scope.DEFAULT })
export class ConfigService {
  private readonly config: Record<string, any>;
  
  constructor() {
    this.config = this.loadConfig();
  }
  
  get(key: string): any {
    return this.config[key];
  }
}

// è¯·æ±‚ä½œç”¨åŸŸï¼šç”¨æˆ·ä¸Šä¸‹æ–‡æœåŠ¡ï¼ˆæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ï¼‰
@Injectable({ scope: Scope.REQUEST })
export class UserContextService {
  private currentUser: User;
  
  setCurrentUser(user: User) {
    this.currentUser = user;
  }
  
  getCurrentUser(): User {
    return this.currentUser;
  }
}

// ç¬æ€ä½œç”¨åŸŸï¼šæ–‡ä»¶å¤„ç†æœåŠ¡ï¼ˆæ¯æ¬¡ä½¿ç”¨éƒ½åˆ›å»ºæ–°å®ä¾‹ï¼‰
@Injectable({ scope: Scope.TRANSIENT })
export class FileProcessorService {
  private processingState: ProcessingState;
  
  processFile(file: File): Promise<ProcessedFile> {
    this.processingState = new ProcessingState();
    // å¤„ç†æ–‡ä»¶é€»è¾‘
    return this.doProcess(file);
  }
}
```

---

## ğŸ›ï¸ 2.3 é…ç½®ç®¡ç†ï¼šå­¦ä¼šæ¨¡å—çš„é…ç½®å’Œç»„ç»‡

### ğŸ’¡ æ ¸å¿ƒæ€æƒ³ï¼šé…ç½®æ˜¯æ¨¡å—çš„"è¯´æ˜ä¹¦"

> **é€šä¿—ç†è§£**ï¼šæ¨¡å—é…ç½®å°±åƒå®¶ç”µçš„è¯´æ˜ä¹¦ï¼Œå‘Šè¯‰ä½ å¦‚ä½•æ­£ç¡®å®‰è£…ã€è¿æ¥å’Œä½¿ç”¨è¿™ä¸ª"è®¾å¤‡"ã€‚å¥½çš„é…ç½®è®¾è®¡è®©æ¨¡å—æ—¢çµæ´»åˆæ˜“ç”¨ã€‚

### ğŸŒ ç°å®åº”ç”¨åœºæ™¯

1. **äº‘æœåŠ¡é…ç½®**ï¼šé˜¿é‡Œäº‘ã€è…¾è®¯äº‘çš„æœåŠ¡é…ç½®
   - ä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ä½¿ç”¨ä¸åŒé…ç½®
   - é…ç½®çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡
   - é…ç½®ç‰ˆæœ¬ç®¡ç†å’Œå›æ»šæœºåˆ¶

2. **å¾®æœåŠ¡é…ç½®ä¸­å¿ƒ**ï¼šSpring Cloud Configã€Nacos
   - é›†ä¸­ç®¡ç†æ‰€æœ‰æœåŠ¡çš„é…ç½®
   - é…ç½®å˜æ›´å®æ—¶æ¨é€åˆ°å„ä¸ªæœåŠ¡
   - é…ç½®æƒé™æ§åˆ¶å’Œå®¡è®¡æ—¥å¿—

### 2.3.1 æ¨¡å—é…ç½®çš„å±‚æ¬¡ç»“æ„

#### ğŸ—ï¸ é…ç½®çš„ä¸‰å±‚æ¶æ„

```mermaid
graph TB
    subgraph "åº”ç”¨é…ç½®å±‚ Application Config"
        A[ç¯å¢ƒå˜é‡ Environment Variables]
        B[é…ç½®æ–‡ä»¶ Config Files]
        C[å‘½ä»¤è¡Œå‚æ•° CLI Arguments]
    end
    
    subgraph "æ¨¡å—é…ç½®å±‚ Module Config"
        D[æ¨¡å—é€‰é¡¹ Module Options]
        E[åŠ¨æ€é…ç½® Dynamic Config]
        F[ç‰¹æ€§å¼€å…³ Feature Flags]
    end
    
    subgraph "æœåŠ¡é…ç½®å±‚ Service Config"
        G[æœåŠ¡å‚æ•° Service Parameters]
        H[ä¾èµ–é…ç½® Dependency Config]
        I[è¿è¡Œæ—¶é…ç½® Runtime Config]
    end
    
    A --> D
    B --> D
    C --> D
    D --> G
    E --> H
    F --> I
    
    style A fill:#ff6b6b
    style B fill:#ff6b6b
    style C fill:#ff6b6b
    style D fill:#4ecdc4
    style E fill:#4ecdc4
    style F fill:#4ecdc4
    style G fill:#ffe66d
    style H fill:#ffe66d
    style I fill:#ffe66d
```

#### ğŸŒŸ ç°å®åº”ç”¨åœºæ™¯ï¼šå¤šç¯å¢ƒé…ç½®ç®¡ç†

```typescript
// ğŸ¯ æ€æƒ³è§£è¯»ï¼šå¦‚ä½•è®¾è®¡çµæ´»çš„æ¨¡å—é…ç½®ç³»ç»Ÿ
// é—®é¢˜ï¼šä¸åŒç¯å¢ƒéœ€è¦ä¸åŒé…ç½®ï¼Œå¦‚ä½•ç»Ÿä¸€ç®¡ç†ï¼Ÿ
// è§£å†³ï¼šåˆ†å±‚é…ç½® + ç¯å¢ƒéš”ç¦» + åŠ¨æ€åŠ è½½

// é…ç½®æ¥å£å®šä¹‰
interface DatabaseConfig {
  type: 'postgres' | 'mysql' | 'sqlite';
  host: string;
  port: number;
  database: string;
  username: string;
  password: string;
  ssl?: boolean;
  poolSize?: number;
  timeout?: number;
}

interface RedisConfig {
  host: string;
  port: number;
  password?: string;
  db?: number;
  keyPrefix?: string;
}

interface AppConfig {
  port: number;
  environment: 'development' | 'testing' | 'production';
  database: DatabaseConfig;
  redis: RedisConfig;
  jwt: {
    secret: string;
    expiresIn: string;
  };
  upload: {
    maxFileSize: number;
    allowedTypes: string[];
    destination: string;
  };
}

// é…ç½®åŠ è½½å™¨
@Injectable()
export class ConfigLoader {
  private config: AppConfig;
  
  constructor() {
    this.config = this.loadConfig();
  }
  
  private loadConfig(): AppConfig {
    const env = process.env.NODE_ENV || 'development';
    
    // åŸºç¡€é…ç½®
    const baseConfig: Partial<AppConfig> = {
      port: parseInt(process.env.PORT) || 3000,
      environment: env as any,
    };
    
    // ç¯å¢ƒç‰¹å®šé…ç½®
    const envConfig = this.loadEnvironmentConfig(env);
    
    // åˆå¹¶é…ç½®
    return {
      ...baseConfig,
      ...envConfig,
    } as AppConfig;
  }
  
  private loadEnvironmentConfig(env: string): Partial<AppConfig> {
    switch (env) {
      case 'development':
        return {
          database: {
            type: 'sqlite',
            host: 'localhost',
            port: 0,
            database: 'blog_dev.db',
            username: '',
            password: '',
          },
          redis: {
            host: 'localhost',
            port: 6379,
            db: 0,
          },
          jwt: {
            secret: 'dev-secret-key',
            expiresIn: '7d',
          },
          upload: {
            maxFileSize: 5 * 1024 * 1024, // 5MB
            allowedTypes: ['image/jpeg', 'image/png', 'image/gif'],
            destination: './uploads/dev',
          },
        };
        
      case 'testing':
        return {
          database: {
            type: 'sqlite',
            host: 'localhost',
            port: 0,
            database: ':memory:', // å†…å­˜æ•°æ®åº“
            username: '',
            password: '',
          },
          redis: {
            host: 'localhost',
            port: 6379,
            db: 1, // ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“
          },
          jwt: {
            secret: 'test-secret-key',
            expiresIn: '1h',
          },
          upload: {
            maxFileSize: 1 * 1024 * 1024, // 1MB
            allowedTypes: ['image/jpeg'],
            destination: './uploads/test',
          },
        };
        
      case 'production':
        return {
          database: {
            type: 'postgres',
            host: process.env.DB_HOST,
            port: parseInt(process.env.DB_PORT),
            database: process.env.DB_NAME,
            username: process.env.DB_USERNAME,
            password: process.env.DB_PASSWORD,
            ssl: true,
            poolSize: 20,
            timeout: 30000,
          },
          redis: {
            host: process.env.REDIS_HOST,
            port: parseInt(process.env.REDIS_PORT),
            password: process.env.REDIS_PASSWORD,
            db: 0,
            keyPrefix: 'blog:',
          },
          jwt: {
            secret: process.env.JWT_SECRET,
            expiresIn: '24h',
          },
          upload: {
            maxFileSize: 10 * 1024 * 1024, // 10MB
            allowedTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            destination: process.env.UPLOAD_PATH || './uploads/prod',
          },
        };
        
      default:
        throw new Error(`æœªçŸ¥çš„ç¯å¢ƒ: ${env}`);
    }
  }
  
  getConfig(): AppConfig {
    return this.config;
  }
  
  get<T extends keyof AppConfig>(key: T): AppConfig[T] {
    return this.config[key];
  }
}

// é…ç½®æ¨¡å—
@Module({
  providers: [
    ConfigLoader,
    {
      provide: 'APP_CONFIG',
      useFactory: (configLoader: ConfigLoader) => configLoader.getConfig(),
      inject: [ConfigLoader],
    },
  ],
  exports: [ConfigLoader, 'APP_CONFIG'],
  global: true, // å…¨å±€æ¨¡å—ï¼Œæ‰€æœ‰æ¨¡å—éƒ½å¯ä»¥ä½¿ç”¨
})
export class ConfigModule {}
```

#### ğŸ”§ åŠ¨æ€æ¨¡å—é…ç½®

```typescript
// ğŸŒŸ é«˜çº§ç‰¹æ€§ï¼šåŠ¨æ€æ¨¡å—é…ç½®å’Œç‰¹æ€§å¼€å…³

// ç‰¹æ€§å¼€å…³é…ç½®
interface FeatureFlags {
  enableUserRegistration: boolean;
  enableEmailNotification: boolean;
  enableFileUpload: boolean;
  enableSocialLogin: boolean;
  enableAdvancedSearch: boolean;
}

// åŠ¨æ€é…ç½®æ¨¡å—
@Module({})
export class DynamicConfigModule {
  static forRoot(options: {
    configPath?: string;
    enableHotReload?: boolean;
    features?: Partial<FeatureFlags>;
  }): DynamicModule {
    
    const providers = [
      {
        provide: 'CONFIG_OPTIONS',
        useValue: options,
      },
      {
        provide: 'FEATURE_FLAGS',
        useValue: {
          enableUserRegistration: true,
          enableEmailNotification: true,
          enableFileUpload: true,
          enableSocialLogin: false,
          enableAdvancedSearch: false,
          ...options.features,
        } as FeatureFlags,
      },
      ConfigService,
    ];
    
    // å¦‚æœå¯ç”¨çƒ­é‡è½½ï¼Œæ·»åŠ é…ç½®ç›‘å¬å™¨
    if (options.enableHotReload) {
      providers.push({
        provide: 'CONFIG_WATCHER',
        useFactory: (configService: ConfigService) => {
          return new ConfigWatcher(configService, options.configPath);
        },
        inject: [ConfigService],
      });
    }
    
    return {
      module: DynamicConfigModule,
      providers,
      exports: providers,
      global: true,
    };
  }
}

// é…ç½®æœåŠ¡
@Injectable()
export class ConfigService {
  constructor(
    @Inject('APP_CONFIG') private readonly appConfig: AppConfig,
    @Inject('FEATURE_FLAGS') private readonly featureFlags: FeatureFlags,
  ) {}
  
  // è·å–åº”ç”¨é…ç½®
  getAppConfig(): AppConfig {
    return this.appConfig;
  }
  
  // è·å–æ•°æ®åº“é…ç½®
  getDatabaseConfig(): DatabaseConfig {
    return this.appConfig.database;
  }
  
  // è·å–Redisé…ç½®
  getRedisConfig(): RedisConfig {
    return this.appConfig.redis;
  }
  
  // æ£€æŸ¥ç‰¹æ€§æ˜¯å¦å¯ç”¨
  isFeatureEnabled(feature: keyof FeatureFlags): boolean {
    return this.featureFlags[feature];
  }
  
  // è·å–æ‰€æœ‰ç‰¹æ€§å¼€å…³
  getFeatureFlags(): FeatureFlags {
    return this.featureFlags;
  }
  
  // åŠ¨æ€æ›´æ–°ç‰¹æ€§å¼€å…³
  updateFeatureFlag(feature: keyof FeatureFlags, enabled: boolean): void {
    this.featureFlags[feature] = enabled;
    console.log(`ğŸ”§ ç‰¹æ€§ ${feature} å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
  }
}

// é…ç½®ç›‘å¬å™¨ï¼ˆçƒ­é‡è½½ï¼‰
export class ConfigWatcher {
  private watcher: FSWatcher;
  
  constructor(
    private readonly configService: ConfigService,
    private readonly configPath: string,
  ) {
    this.startWatching();
  }
  
  private startWatching(): void {
    if (!this.configPath) return;
    
    this.watcher = watch(this.configPath, (eventType, filename) => {
      if (eventType === 'change') {
        console.log(`ğŸ“ é…ç½®æ–‡ä»¶ ${filename} å·²æ›´æ”¹ï¼Œé‡æ–°åŠ è½½é…ç½®...`);
        this.reloadConfig();
      }
    });
    
    console.log(`ğŸ‘€ å¼€å§‹ç›‘å¬é…ç½®æ–‡ä»¶: ${this.configPath}`);
  }
  
  private reloadConfig(): void {
    try {
      // é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
      const newConfig = JSON.parse(readFileSync(this.configPath, 'utf8'));
      
      // æ›´æ–°ç‰¹æ€§å¼€å…³
      if (newConfig.features) {
        Object.keys(newConfig.features).forEach(feature => {
          this.configService.updateFeatureFlag(
            feature as keyof FeatureFlags,
            newConfig.features[feature]
          );
        });
      }
      
      console.log('âœ… é…ç½®é‡æ–°åŠ è½½æˆåŠŸ');
    } catch (error) {
      console.error('âŒ é…ç½®é‡æ–°åŠ è½½å¤±è´¥:', error.message);
    }
  }
  
  destroy(): void {
    if (this.watcher) {
      this.watcher.close();
      console.log('ğŸ”š é…ç½®ç›‘å¬å™¨å·²å…³é—­');
    }
  }
}
```

### 2.3.2 æ¨¡å—ç»„ç»‡ç­–ç•¥

#### ğŸ“ æ¨¡å—ç›®å½•ç»“æ„è®¾è®¡

```typescript
// ğŸ¯ æ€æƒ³è§£è¯»ï¼šå¦‚ä½•ç»„ç»‡æ¨¡å—çš„æ–‡ä»¶ç»“æ„
// é—®é¢˜ï¼šæ¨¡å—æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼Œå¦‚ä½•ä¿æŒæ¸…æ™°çš„ç»“æ„ï¼Ÿ
// è§£å†³ï¼šæŒ‰åŠŸèƒ½åˆ†å±‚ + ç»Ÿä¸€å‘½åè§„èŒƒ + æ¸…æ™°çš„ä¾èµ–å…³ç³»

/*
åšå®¢ç³»ç»Ÿæ¨¡å—ç»„ç»‡ç»“æ„ï¼š

src/
â”œâ”€â”€ app.module.ts                 # åº”ç”¨æ ¹æ¨¡å—
â”œâ”€â”€ main.ts                       # åº”ç”¨å…¥å£
â”œâ”€â”€ common/                       # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ config/                   # é…ç½®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config.module.ts
â”‚   â”‚   â”œâ”€â”€ config.service.ts
â”‚   â”‚   â””â”€â”€ config.interface.ts
â”‚   â”œâ”€â”€ database/                 # æ•°æ®åº“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ database.module.ts
â”‚   â”‚   â”œâ”€â”€ database.service.ts
â”‚   â”‚   â””â”€â”€ database.config.ts
â”‚   â”œâ”€â”€ cache/                    # ç¼“å­˜æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ cache.module.ts
â”‚   â”‚   â”œâ”€â”€ cache.service.ts
â”‚   â”‚   â””â”€â”€ cache.interface.ts
â”‚   â””â”€â”€ logger/                   # æ—¥å¿—æ¨¡å—
â”‚       â”œâ”€â”€ logger.module.ts
â”‚       â”œâ”€â”€ logger.service.ts
â”‚       â””â”€â”€ logger.config.ts
â”œâ”€â”€ modules/                      # ä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ auth/                     # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”œâ”€â”€ strategies/           # è®¤è¯ç­–ç•¥
â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”‚   â”‚   â””â”€â”€ local.strategy.ts
â”‚   â”‚   â”œâ”€â”€ guards/               # å®ˆå«
â”‚   â”‚   â”‚   â”œâ”€â”€ jwt-auth.guard.ts
â”‚   â”‚   â”‚   â””â”€â”€ roles.guard.ts
â”‚   â”‚   â”œâ”€â”€ decorators/           # è£…é¥°å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ roles.decorator.ts
â”‚   â”‚   â”‚   â””â”€â”€ current-user.decorator.ts
â”‚   â”‚   â””â”€â”€ dto/                  # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚       â”œâ”€â”€ login.dto.ts
â”‚   â”‚       â””â”€â”€ register.dto.ts
â”‚   â”œâ”€â”€ user/                     # ç”¨æˆ·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ user.module.ts
â”‚   â”‚   â”œâ”€â”€ user.controller.ts
â”‚   â”‚   â”œâ”€â”€ user.service.ts
â”‚   â”‚   â”œâ”€â”€ user.repository.ts
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ user.entity.ts
â”‚   â”‚   â”‚   â””â”€â”€ user-profile.entity.ts
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-user.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ update-user.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ user-response.dto.ts
â”‚   â”‚   â””â”€â”€ interfaces/
â”‚   â”‚       â””â”€â”€ user.interface.ts
â”‚   â”œâ”€â”€ article/                  # æ–‡ç« æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ article.module.ts
â”‚   â”‚   â”œâ”€â”€ article.controller.ts
â”‚   â”‚   â”œâ”€â”€ article.service.ts
â”‚   â”‚   â”œâ”€â”€ article.repository.ts
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â””â”€â”€ article.entity.ts
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-article.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ update-article.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ article-query.dto.ts
â”‚   â”‚   â””â”€â”€ interfaces/
â”‚   â”‚       â””â”€â”€ article.interface.ts
â”‚   â””â”€â”€ comment/                  # è¯„è®ºæ¨¡å—
â”‚       â”œâ”€â”€ comment.module.ts
â”‚       â”œâ”€â”€ comment.controller.ts
â”‚       â”œâ”€â”€ comment.service.ts
â”‚       â”œâ”€â”€ comment.repository.ts
â”‚       â”œâ”€â”€ entities/
â”‚       â”‚   â””â”€â”€ comment.entity.ts
â”‚       â””â”€â”€ dto/
â”‚           â”œâ”€â”€ create-comment.dto.ts
â”‚           â””â”€â”€ update-comment.dto.ts
â””â”€â”€ shared/                       # å…±äº«æ¨¡å—
    â”œâ”€â”€ interfaces/               # å…±äº«æ¥å£
    â”œâ”€â”€ enums/                    # æšä¸¾å®šä¹‰
    â”œâ”€â”€ constants/                # å¸¸é‡å®šä¹‰
    â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
    â””â”€â”€ types/                    # ç±»å‹å®šä¹‰
*/

// æ¨¡å—ç»„ç»‡çš„æœ€ä½³å®è·µ
@Module({
  imports: [
    // 1. é¦–å…ˆå¯¼å…¥åŸºç¡€è®¾æ–½æ¨¡å—
    ConfigModule,
    DatabaseModule,
    CacheModule,
    LoggerModule,
    
    // 2. ç„¶åå¯¼å…¥ä¸šåŠ¡æ¨¡å—ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
    AuthModule,
    UserModule,
    ArticleModule,
    CommentModule,
  ],
})
export class AppModule {}
```

#### ğŸ”„ æ¨¡å—æ‡’åŠ è½½å’ŒæŒ‰éœ€åŠ è½½

```typescript
// ğŸŒŸ é«˜çº§ç‰¹æ€§ï¼šæ¨¡å—æ‡’åŠ è½½ä¼˜åŒ–æ€§èƒ½

// æ‡’åŠ è½½æ¨¡å—æ¥å£
interface LazyModule {
  module: Type<any>;
  condition?: () => boolean;
  priority?: number;
}

// æ¨¡å—åŠ è½½å™¨
@Injectable()
export class ModuleLoader {
  private loadedModules = new Set<string>();
  
  constructor(
    private readonly moduleRef: ModuleRef,
    @Inject('FEATURE_FLAGS') private readonly featureFlags: FeatureFlags,
  ) {}
  
  // æŒ‰éœ€åŠ è½½æ¨¡å—
  async loadModuleIfNeeded(moduleName: string, moduleClass: Type<any>): Promise<void> {
    if (this.loadedModules.has(moduleName)) {
      return; // æ¨¡å—å·²åŠ è½½
    }
    
    // æ£€æŸ¥æ˜¯å¦æ»¡è¶³åŠ è½½æ¡ä»¶
    if (!this.shouldLoadModule(moduleName)) {
      console.log(`â­ï¸ è·³è¿‡æ¨¡å—åŠ è½½: ${moduleName}`);
      return;
    }
    
    try {
      console.log(`ğŸ”„ å¼€å§‹åŠ è½½æ¨¡å—: ${moduleName}`);
      
      // åŠ¨æ€å¯¼å…¥æ¨¡å—
      const moduleRef = await this.moduleRef.create(moduleClass);
      
      this.loadedModules.add(moduleName);
      console.log(`âœ… æ¨¡å—åŠ è½½æˆåŠŸ: ${moduleName}`);
      
    } catch (error) {
      console.error(`âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${moduleName}`, error);
      throw error;
    }
  }
  
  private shouldLoadModule(moduleName: string): boolean {
    switch (moduleName) {
      case 'EmailModule':
        return this.featureFlags.enableEmailNotification;
      case 'UploadModule':
        return this.featureFlags.enableFileUpload;
      case 'SocialLoginModule':
        return this.featureFlags.enableSocialLogin;
      case 'SearchModule':
        return this.featureFlags.enableAdvancedSearch;
      default:
        return true; // é»˜è®¤åŠ è½½
    }
  }
  
  // è·å–å·²åŠ è½½çš„æ¨¡å—åˆ—è¡¨
  getLoadedModules(): string[] {
    return Array.from(this.loadedModules);
  }
  
  // å¸è½½æ¨¡å—
  async unloadModule(moduleName: string): Promise<void> {
    if (!this.loadedModules.has(moduleName)) {
      return;
    }
    
    // æ‰§è¡Œæ¨¡å—æ¸…ç†é€»è¾‘
    console.log(`ğŸ—‘ï¸ å¸è½½æ¨¡å—: ${moduleName}`);
    this.loadedModules.delete(moduleName);
  }
}

// æ¡ä»¶æ¨¡å—è£…é¥°å™¨
export function ConditionalModule(condition: () => boolean) {
  return function <T extends Type<any>>(target: T): T {
    const originalModule = target;
    
    // åˆ›å»ºåŒ…è£…æ¨¡å—
    @Module({})
    class ConditionalWrapper {
      static forRoot(): DynamicModule {
        if (condition()) {
          return {
            module: ConditionalWrapper,
            imports: [originalModule],
            exports: [originalModule],
          };
        } else {
          return {
            module: ConditionalWrapper,
            providers: [],
            exports: [],
          };
        }
      }
    }
    
    return ConditionalWrapper as any;
  };
}

// ä½¿ç”¨æ¡ä»¶æ¨¡å—
@ConditionalModule(() => process.env.ENABLE_EMAIL === 'true')
@Module({
  providers: [EmailService],
  exports: [EmailService],
})
export class EmailModule {}

@ConditionalModule(() => process.env.ENABLE_UPLOAD === 'true')
@Module({
  providers: [UploadService],
  controllers: [UploadController],
  exports: [UploadService],
})
export class UploadModule {}
```

---

## ğŸ”„ 2.4 é€šä¿¡æœºåˆ¶ï¼šç†è§£æ¨¡å—é—´çš„é€šä¿¡æ–¹å¼

### ğŸ’¡ æ ¸å¿ƒæ€æƒ³ï¼šé€šä¿¡æœºåˆ¶æ˜¯æ¨¡å—åä½œçš„"è¯­è¨€"

> **é€šä¿—ç†è§£**ï¼šæ¨¡å—é—´çš„é€šä¿¡å°±åƒä¸åŒéƒ¨é—¨ä¹‹é—´çš„åä½œã€‚æœ‰çš„é€šè¿‡é‚®ä»¶ï¼ˆå¼‚æ­¥æ¶ˆæ¯ï¼‰ï¼Œæœ‰çš„é€šè¿‡ç”µè¯ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ï¼Œæœ‰çš„é€šè¿‡ä¼šè®®ï¼ˆäº‹ä»¶å¹¿æ’­ï¼‰ï¼Œé€‰æ‹©åˆé€‚çš„é€šä¿¡æ–¹å¼èƒ½è®©åä½œæ›´é«˜æ•ˆã€‚

### ğŸŒ ç°å®åº”ç”¨åœºæ™¯

1. **ç”µå•†è®¢å•æµç¨‹**ï¼š
   - è®¢å•æ¨¡å— â†’ åº“å­˜æ¨¡å—ï¼šåŒæ­¥æ£€æŸ¥åº“å­˜
   - è®¢å•æ¨¡å— â†’ æ”¯ä»˜æ¨¡å—ï¼šå¼‚æ­¥å¤„ç†æ”¯ä»˜
   - æ”¯ä»˜æˆåŠŸ â†’ å‘è´§æ¨¡å—ï¼šäº‹ä»¶é©±åŠ¨å‘è´§

2. **ç¤¾äº¤åª’ä½“ç³»ç»Ÿ**ï¼š
   - ç”¨æˆ·å‘å¸ƒåŠ¨æ€ â†’ æ¨é€ç»™å…³æ³¨è€…ï¼ˆäº‹ä»¶å¹¿æ’­ï¼‰
   - ç‚¹èµè¯„è®º â†’ å®æ—¶é€šçŸ¥ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
   - å†…å®¹å®¡æ ¸ â†’ è‡ªåŠ¨å¤„ç†ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰

### 2.4.1 åŒæ­¥é€šä¿¡ï¼šç›´æ¥æœåŠ¡è°ƒç”¨

#### ğŸ”— æœåŠ¡é—´çš„ç›´æ¥ä¾èµ–æ³¨å…¥

```typescript
// ğŸ¯ æ€æƒ³è§£è¯»ï¼šåŒæ­¥é€šä¿¡çš„é€‚ç”¨åœºæ™¯
// é—®é¢˜ï¼šä»€ä¹ˆæ—¶å€™ä½¿ç”¨åŒæ­¥é€šä¿¡ï¼Ÿ
// è§£å†³ï¼šéœ€è¦ç«‹å³è·å¾—ç»“æœã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯

// ğŸŒŸ ç°å®åº”ç”¨åœºæ™¯ï¼šç”µå•†ä¸‹å•æµç¨‹çš„åŒæ­¥é€šä¿¡

// ç”¨æˆ·æœåŠ¡ï¼šæä¾›ç”¨æˆ·éªŒè¯
@Injectable()
export class UserService {
  constructor(
    private readonly userRepository: UserRepository,
  ) {}
  
  async validateUser(userId: number): Promise<User> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new NotFoundException('ç”¨æˆ·ä¸å­˜åœ¨');
    }
    if (!user.isActive) {
      throw new ForbiddenException('ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨');
    }
    return user;
  }
  
  async getUserBalance(userId: number): Promise<number> {
    const user = await this.validateUser(userId);
    return user.balance;
  }
}

// å•†å“æœåŠ¡ï¼šæä¾›å•†å“ä¿¡æ¯
@Injectable()
export class ProductService {
  constructor(
    private readonly productRepository: ProductRepository,
  ) {}
  
  async validateProduct(productId: number, quantity: number): Promise<Product> {
    const product = await this.productRepository.findById(productId);
    if (!product) {
      throw new NotFoundException('å•†å“ä¸å­˜åœ¨');
    }
    if (!product.isAvailable) {
      throw new BadRequestException('å•†å“å·²ä¸‹æ¶');
    }
    if (product.stock < quantity) {
      throw new BadRequestException(`åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š${product.stock}`);
    }
    return product;
  }
  
  async calculatePrice(productId: number, quantity: number): Promise<number> {
    const product = await this.validateProduct(productId, quantity);
    return product.price * quantity;
  }
}

// åº“å­˜æœåŠ¡ï¼šç®¡ç†å•†å“åº“å­˜
@Injectable()
export class InventoryService {
  constructor(
    private readonly inventoryRepository: InventoryRepository,
  ) {}
  
  async checkStock(productId: number, quantity: number): Promise<boolean> {
    const inventory = await this.inventoryRepository.findByProductId(productId);
    return inventory && inventory.quantity >= quantity;
  }
  
  async reserveStock(productId: number, quantity: number): Promise<string> {
    const hasStock = await this.checkStock(productId, quantity);
    if (!hasStock) {
      throw new BadRequestException('åº“å­˜ä¸è¶³');
    }
    
    // é¢„ç•™åº“å­˜
    const reservationId = `reserve_${Date.now()}_${Math.random()}`;
    await this.inventoryRepository.reserve(productId, quantity, reservationId);
    
    console.log(`ğŸ“¦ åº“å­˜é¢„ç•™æˆåŠŸ: å•†å“${productId}, æ•°é‡${quantity}, é¢„ç•™ID${reservationId}`);
    return reservationId;
  }
  
  async confirmReservation(reservationId: string): Promise<void> {
    await this.inventoryRepository.confirmReservation(reservationId);
    console.log(`âœ… åº“å­˜é¢„ç•™ç¡®è®¤: ${reservationId}`);
  }
  
  async cancelReservation(reservationId: string): Promise<void> {
    await this.inventoryRepository.cancelReservation(reservationId);
    console.log(`âŒ åº“å­˜é¢„ç•™å–æ¶ˆ: ${reservationId}`);
  }
}

// è®¢å•æœåŠ¡ï¼šåè°ƒå¤šä¸ªæœåŠ¡å®Œæˆä¸‹å•
@Injectable()
export class OrderService {
  constructor(
    private readonly userService: UserService,           // æ³¨å…¥ç”¨æˆ·æœåŠ¡
    private readonly productService: ProductService,     // æ³¨å…¥å•†å“æœåŠ¡
    private readonly inventoryService: InventoryService, // æ³¨å…¥åº“å­˜æœåŠ¡
    private readonly orderRepository: OrderRepository,
  ) {}
  
  async createOrder(createOrderDto: CreateOrderDto): Promise<Order> {
    const { userId, items } = createOrderDto;
    
    // 1. åŒæ­¥éªŒè¯ç”¨æˆ·ï¼ˆå¿…é¡»ç«‹å³çŸ¥é“ç»“æœï¼‰
    console.log('ğŸ‘¤ éªŒè¯ç”¨æˆ·èº«ä»½...');
    const user = await this.userService.validateUser(userId);
    
    // 2. åŒæ­¥éªŒè¯å•†å“å’Œè®¡ç®—ä»·æ ¼
    console.log('ğŸ›ï¸ éªŒè¯å•†å“ä¿¡æ¯...');
    const orderItems = [];
    let totalAmount = 0;
    
    for (const item of items) {
      const product = await this.productService.validateProduct(
        item.productId, 
        item.quantity
      );
      const itemTotal = await this.productService.calculatePrice(
        item.productId, 
        item.quantity
      );
      
      orderItems.push({
        product,
        quantity: item.quantity,
        price: product.price,
        total: itemTotal,
      });
      
      totalAmount += itemTotal;
    }
    
    // 3. åŒæ­¥æ£€æŸ¥ç”¨æˆ·ä½™é¢
    console.log('ğŸ’° æ£€æŸ¥ç”¨æˆ·ä½™é¢...');
    const userBalance = await this.userService.getUserBalance(userId);
    if (userBalance < totalAmount) {
      throw new BadRequestException('ä½™é¢ä¸è¶³');
    }
    
    // 4. åŒæ­¥é¢„ç•™åº“å­˜ï¼ˆå…³é”®æ­¥éª¤ï¼Œå¿…é¡»ç«‹å³æ‰§è¡Œï¼‰
    console.log('ğŸ“¦ é¢„ç•™å•†å“åº“å­˜...');
    const reservations = [];
    try {
      for (const item of orderItems) {
        const reservationId = await this.inventoryService.reserveStock(
          item.product.id,
          item.quantity
        );
        reservations.push(reservationId);
      }
      
      // 5. åˆ›å»ºè®¢å•
      console.log('ğŸ“ åˆ›å»ºè®¢å•è®°å½•...');
      const order = await this.orderRepository.create({
        user,
        items: orderItems,
        totalAmount,
        status: OrderStatus.PENDING,
        reservations,
      });
      
      console.log(`âœ… è®¢å•åˆ›å»ºæˆåŠŸ: ${order.id}`);
      return order;
      
    } catch (error) {
      // å¦‚æœå‡ºé”™ï¼Œå›æ»šæ‰€æœ‰é¢„ç•™çš„åº“å­˜
      console.log('âŒ è®¢å•åˆ›å»ºå¤±è´¥ï¼Œå›æ»šåº“å­˜é¢„ç•™...');
      for (const reservationId of reservations) {
        await this.inventoryService.cancelReservation(reservationId);
      }
      throw error;
    }
  }
  
  async confirmOrder(orderId: number): Promise<void> {
    const order = await this.orderRepository.findById(orderId);
    if (!order) {
      throw new NotFoundException('è®¢å•ä¸å­˜åœ¨');
    }
    
    // ç¡®è®¤æ‰€æœ‰åº“å­˜é¢„ç•™
    for (const reservationId of order.reservations) {
      await this.inventoryService.confirmReservation(reservationId);
    }
    
    // æ›´æ–°è®¢å•çŠ¶æ€
    await this.orderRepository.updateStatus(orderId, OrderStatus.CONFIRMED);
    console.log(`âœ… è®¢å•ç¡®è®¤æˆåŠŸ: ${orderId}`);
  }
}
```

#### ğŸ”„ æ¥å£é€‚é…å™¨æ¨¡å¼

```typescript
// ğŸŒŸ é«˜çº§ç‰¹æ€§ï¼šä½¿ç”¨é€‚é…å™¨æ¨¡å¼è§£è€¦æœåŠ¡é€šä¿¡

// å®šä¹‰ç»Ÿä¸€çš„æœåŠ¡æ¥å£
interface PaymentProvider {
  processPayment(amount: number, paymentMethod: string): Promise<PaymentResult>;
  refund(transactionId: string, amount: number): Promise<RefundResult>;
  queryStatus(transactionId: string): Promise<PaymentStatus>;
}

// æ”¯ä»˜å®é€‚é…å™¨
@Injectable()
export class AlipayAdapter implements PaymentProvider {
  async processPayment(amount: number, paymentMethod: string): Promise<PaymentResult> {
    // è°ƒç”¨æ”¯ä»˜å®API
    console.log(`ğŸ’° æ”¯ä»˜å®æ”¯ä»˜: Â¥${amount}`);
    return {
      success: true,
      transactionId: `alipay_${Date.now()}`,
      amount,
    };
  }
  
  async refund(transactionId: string, amount: number): Promise<RefundResult> {
    console.log(`â†©ï¸ æ”¯ä»˜å®é€€æ¬¾: ${transactionId}, Â¥${amount}`);
    return { success: true, refundId: `refund_${Date.now()}` };
  }
  
  async queryStatus(transactionId: string): Promise<PaymentStatus> {
    return { status: 'completed', transactionId };
  }
}

// å¾®ä¿¡æ”¯ä»˜é€‚é…å™¨
@Injectable()
export class WechatPayAdapter implements PaymentProvider {
  async processPayment(amount: number, paymentMethod: string): Promise<PaymentResult> {
    console.log(`ğŸ’° å¾®ä¿¡æ”¯ä»˜: Â¥${amount}`);
    return {
      success: true,
      transactionId: `wechat_${Date.now()}`,
      amount,
    };
  }
  
  async refund(transactionId: string, amount: number): Promise<RefundResult> {
    console.log(`â†©ï¸ å¾®ä¿¡é€€æ¬¾: ${transactionId}, Â¥${amount}`);
    return { success: true, refundId: `wechat_refund_${Date.now()}` };
  }
  
  async queryStatus(transactionId: string): Promise<PaymentStatus> {
    return { status: 'completed', transactionId };
  }
}

// æ”¯ä»˜æœåŠ¡ï¼šä½¿ç”¨é€‚é…å™¨æ¨¡å¼ç»Ÿä¸€æ¥å£
@Injectable()
export class PaymentService {
  private providers = new Map<string, PaymentProvider>();
  
  constructor(
    private readonly alipayAdapter: AlipayAdapter,
    private readonly wechatPayAdapter: WechatPayAdapter,
  ) {
    this.providers.set('alipay', this.alipayAdapter);
    this.providers.set('wechat', this.wechatPayAdapter);
  }
  
  async processPayment(
    provider: string, 
    amount: number, 
    paymentMethod: string
  ): Promise<PaymentResult> {
    const paymentProvider = this.providers.get(provider);
    if (!paymentProvider) {
      throw new BadRequestException(`ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼: ${provider}`);
    }
    
    return await paymentProvider.processPayment(amount, paymentMethod);
  }
  
  async refund(
    provider: string, 
    transactionId: string, 
    amount: number
  ): Promise<RefundResult> {
    const paymentProvider = this.providers.get(provider);
    if (!paymentProvider) {
      throw new BadRequestException(`ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼: ${provider}`);
    }
    
    return await paymentProvider.refund(transactionId, amount);
  }
}
```

### 2.4.2 å¼‚æ­¥é€šä¿¡ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„

#### ğŸ“¡ äº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼

```typescript
// ğŸ¯ æ€æƒ³è§£è¯»ï¼šå¼‚æ­¥é€šä¿¡çš„ä¼˜åŠ¿
// é—®é¢˜ï¼šåŒæ­¥é€šä¿¡ä¼šé˜»å¡ä¸»æµç¨‹ï¼Œå¦‚ä½•è§£è€¦ï¼Ÿ
// è§£å†³ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå‘å¸ƒè€…å’Œè®¢é˜…è€…è§£è€¦

// å®šä¹‰äº‹ä»¶ç±»å‹
export class UserRegisteredEvent {
  constructor(
    public readonly userId: number,
    public readonly email: string,
    public readonly username: string,
    public readonly registeredAt: Date,
  ) {}
}

export class OrderCreatedEvent {
  constructor(
    public readonly orderId: number,
    public readonly userId: number,
    public readonly totalAmount: number,
    public readonly items: OrderItem[],
    public readonly createdAt: Date,
  ) {}
}

export class PaymentCompletedEvent {
  constructor(
    public readonly orderId: number,
    public readonly paymentId: string,
    public readonly amount: number,
    public readonly paymentMethod: string,
    public readonly completedAt: Date,
  ) {}
}

// äº‹ä»¶å‘å¸ƒè€…ï¼šç”¨æˆ·æœåŠ¡
@Injectable()
export class UserService {
  constructor(
    private readonly userRepository: UserRepository,
    private readonly eventEmitter: EventEmitter2, // æ³¨å…¥äº‹ä»¶å‘å°„å™¨
  ) {}
  
  async registerUser(registerDto: RegisterUserDto): Promise<User> {
    // 1. åˆ›å»ºç”¨æˆ·
    const user = await this.userRepository.create({
      email: registerDto.email,
      username: registerDto.username,
      password: await this.hashPassword(registerDto.password),
    });
    
    console.log(`ğŸ‘¤ ç”¨æˆ·æ³¨å†ŒæˆåŠŸ: ${user.username}`);
    
    // 2. å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼ˆå¼‚æ­¥ï¼‰
    const event = new UserRegisteredEvent(
      user.id,
      user.email,
      user.username,
      new Date(),
    );
    
    this.eventEmitter.emit('user.registered', event);
    console.log(`ğŸ“¡ å‘å¸ƒäº‹ä»¶: user.registered`);
    
    return user;
  }
  
  private async hashPassword(password: string): Promise<string> {
    // å¯†ç å“ˆå¸Œé€»è¾‘
    return `hashed_${password}`;
  }
}

// äº‹ä»¶è®¢é˜…è€…ï¼šé‚®ä»¶æœåŠ¡
@Injectable()
export class EmailService {
  constructor(
    private readonly configService: ConfigService,
  ) {}
  
  @OnEvent('user.registered')
  async handleUserRegistered(event: UserRegisteredEvent) {
    console.log(`ğŸ“§ å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶: ${event.username}`);
    
    try {
      // å‘é€æ¬¢è¿é‚®ä»¶
      await this.sendWelcomeEmail(event.email, event.username);
      console.log(`âœ… æ¬¢è¿é‚®ä»¶å‘é€æˆåŠŸ: ${event.email}`);
    } catch (error) {
      console.error(`âŒ æ¬¢è¿é‚®ä»¶å‘é€å¤±è´¥: ${event.email}`, error);
      // å¯ä»¥é€‰æ‹©é‡è¯•æˆ–è®°å½•åˆ°å¤±è´¥é˜Ÿåˆ—
    }
  }
  
  @OnEvent('order.created')
  async handleOrderCreated(event: OrderCreatedEvent) {
    console.log(`ğŸ“§ å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶: ${event.orderId}`);
    
    try {
      await this.sendOrderConfirmationEmail(event);
      console.log(`âœ… è®¢å•ç¡®è®¤é‚®ä»¶å‘é€æˆåŠŸ: ${event.orderId}`);
    } catch (error) {
      console.error(`âŒ è®¢å•ç¡®è®¤é‚®ä»¶å‘é€å¤±è´¥: ${event.orderId}`, error);
    }
  }
  
  private async sendWelcomeEmail(email: string, username: string): Promise<void> {
    // æ¨¡æ‹Ÿå‘é€é‚®ä»¶
    await new Promise(resolve => setTimeout(resolve, 1000));
    console.log(`ğŸ“¬ æ¬¢è¿é‚®ä»¶å·²å‘é€åˆ°: ${email}`);
  }
  
  private async sendOrderConfirmationEmail(event: OrderCreatedEvent): Promise<void> {
    await new Promise(resolve => setTimeout(resolve, 500));
    console.log(`ğŸ“¬ è®¢å•ç¡®è®¤é‚®ä»¶å·²å‘é€: è®¢å•${event.orderId}`);
  }
}

// äº‹ä»¶è®¢é˜…è€…ï¼šé€šçŸ¥æœåŠ¡
@Injectable()
export class NotificationService {
  @OnEvent('user.registered')
  async handleUserRegistered(event: UserRegisteredEvent) {
    console.log(`ğŸ”” å¤„ç†ç”¨æˆ·æ³¨å†Œé€šçŸ¥: ${event.username}`);
    
    // å‘é€ç³»ç»Ÿé€šçŸ¥
    await this.sendSystemNotification(
      event.userId,
      'æ¬¢è¿åŠ å…¥æˆ‘ä»¬ï¼',
      'æ„Ÿè°¢æ‚¨çš„æ³¨å†Œï¼Œå¼€å§‹æ¢ç´¢æˆ‘ä»¬çš„æœåŠ¡å§ï¼'
    );
  }
  
  @OnEvent('payment.completed')
  async handlePaymentCompleted(event: PaymentCompletedEvent) {
    console.log(`ğŸ”” å¤„ç†æ”¯ä»˜å®Œæˆé€šçŸ¥: è®¢å•${event.orderId}`);
    
    // å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥
    await this.sendPaymentNotification(event);
  }
  
  private async sendSystemNotification(
    userId: number, 
    title: string, 
    content: string
  ): Promise<void> {
    console.log(`ğŸ”” ç³»ç»Ÿé€šçŸ¥ -> ç”¨æˆ·${userId}: ${title}`);
  }
  
  private async sendPaymentNotification(event: PaymentCompletedEvent): Promise<void> {
    console.log(`ğŸ’° æ”¯ä»˜é€šçŸ¥: è®¢å•${event.orderId}æ”¯ä»˜æˆåŠŸï¼Œé‡‘é¢Â¥${event.amount}`);
  }
}

// äº‹ä»¶è®¢é˜…è€…ï¼šæ•°æ®ç»Ÿè®¡æœåŠ¡
@Injectable()
export class AnalyticsService {
  @OnEvent('user.registered')
  async handleUserRegistered(event: UserRegisteredEvent) {
    console.log(`ğŸ“Š è®°å½•ç”¨æˆ·æ³¨å†Œç»Ÿè®¡: ${event.username}`);
    
    // æ›´æ–°ç”¨æˆ·æ³¨å†Œç»Ÿè®¡
    await this.updateUserRegistrationStats(event.registeredAt);
  }
  
  @OnEvent('order.created')
  async handleOrderCreated(event: OrderCreatedEvent) {
    console.log(`ğŸ“Š è®°å½•è®¢å•ç»Ÿè®¡: ${event.orderId}`);
    
    // æ›´æ–°è®¢å•ç»Ÿè®¡
    await this.updateOrderStats(event);
  }
  
  @OnEvent('payment.completed')
  async handlePaymentCompleted(event: PaymentCompletedEvent) {
    console.log(`ğŸ“Š è®°å½•æ”¯ä»˜ç»Ÿè®¡: ${event.paymentId}`);
    
    // æ›´æ–°æ”¯ä»˜ç»Ÿè®¡
    await this.updatePaymentStats(event);
  }
  
  private async updateUserRegistrationStats(registeredAt: Date): Promise<void> {
    // æ›´æ–°ç”¨æˆ·æ³¨å†Œç»Ÿè®¡æ•°æ®
    console.log(`ğŸ“ˆ ç”¨æˆ·æ³¨å†Œç»Ÿè®¡å·²æ›´æ–°`);
  }
  
  private async updateOrderStats(event: OrderCreatedEvent): Promise<void> {
    console.log(`ğŸ“ˆ è®¢å•ç»Ÿè®¡å·²æ›´æ–°: é‡‘é¢Â¥${event.totalAmount}`);
  }
  
  private async updatePaymentStats(event: PaymentCompletedEvent): Promise<void> {
    console.log(`ğŸ“ˆ æ”¯ä»˜ç»Ÿè®¡å·²æ›´æ–°: ${event.paymentMethod}, Â¥${event.amount}`);
  }
}
```

#### ğŸ”„ æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ

```typescript
// ğŸŒŸ é«˜çº§ç‰¹æ€§ï¼šé›†æˆæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¯é çš„å¼‚æ­¥é€šä¿¡

// æ¶ˆæ¯é˜Ÿåˆ—é…ç½®
interface QueueConfig {
  name: string;
  options: {
    durable: boolean;
    maxRetries: number;
    retryDelay: number;
  };
}

// é˜Ÿåˆ—æœåŠ¡
@Injectable()
export class QueueService {
  private queues = new Map<string, any>();
  
  constructor() {
    this.initializeQueues();
  }
  
  private initializeQueues(): void {
    const queueConfigs: QueueConfig[] = [
      {
        name: 'email-queue',
        options: { durable: true, maxRetries: 3, retryDelay: 5000 }
      },
      {
        name: 'notification-queue',
        options: { durable: true, maxRetries: 2, retryDelay: 3000 }
      },
      {
        name: 'analytics-queue',
        options: { durable: false, maxRetries: 1, retryDelay: 1000 }
      },
    ];
    
    queueConfigs.forEach(config => {
      this.queues.set(config.name, this.createQueue(config));
    });
  }
  
  private createQueue(config: QueueConfig): any {
    console.log(`ğŸ”§ åˆ›å»ºé˜Ÿåˆ—: ${config.name}`);
    return {
      name: config.name,
      options: config.options,
      messages: [],
    };
  }
  
  async addJob(queueName: string, jobData: any, options?: any): Promise<void> {
    const queue = this.queues.get(queueName);
    if (!queue) {
      throw new Error(`é˜Ÿåˆ—ä¸å­˜åœ¨: ${queueName}`);
    }
    
    const job = {
      id: `job_${Date.now()}_${Math.random()}`,
      data: jobData,
      attempts: 0,
      maxRetries: queue.options.maxRetries,
      createdAt: new Date(),
      ...options,
    };
    
    queue.messages.push(job);
    console.log(`ğŸ“¤ ä»»åŠ¡å·²æ·»åŠ åˆ°é˜Ÿåˆ— ${queueName}: ${job.id}`);
    
    // ç«‹å³å¤„ç†ä»»åŠ¡ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¼šç”±é˜Ÿåˆ—å¤„ç†å™¨å¼‚æ­¥å¤„ç†ï¼‰
    setTimeout(() => this.processJob(queueName, job), 100);
  }
  
  private async processJob(queueName: string, job: any): Promise<void> {
    try {
      console.log(`âš™ï¸ å¤„ç†ä»»åŠ¡: ${job.id} (é˜Ÿåˆ—: ${queueName})`);
      
      // æ ¹æ®é˜Ÿåˆ—ç±»å‹å¤„ç†ä¸åŒçš„ä»»åŠ¡
      switch (queueName) {
        case 'email-queue':
          await this.processEmailJob(job);
          break;
        case 'notification-queue':
          await this.processNotificationJob(job);
          break;
        case 'analytics-queue':
          await this.processAnalyticsJob(job);
          break;
        default:
          throw new Error(`æœªçŸ¥çš„é˜Ÿåˆ—ç±»å‹: ${queueName}`);
      }
      
      console.log(`âœ… ä»»åŠ¡å¤„ç†æˆåŠŸ: ${job.id}`);
      
    } catch (error) {
      console.error(`âŒ ä»»åŠ¡å¤„ç†å¤±è´¥: ${job.id}`, error);
      
      // é‡è¯•é€»è¾‘
      job.attempts++;
      if (job.attempts < job.maxRetries) {
        console.log(`ğŸ”„ ä»»åŠ¡é‡è¯• (${job.attempts}/${job.maxRetries}): ${job.id}`);
        setTimeout(() => this.processJob(queueName, job), 5000);
      } else {
        console.error(`ğŸ’€ ä»»åŠ¡æœ€ç»ˆå¤±è´¥: ${job.id}`);
        // å¯ä»¥å°†å¤±è´¥çš„ä»»åŠ¡ç§»åˆ°æ­»ä¿¡é˜Ÿåˆ—
      }
    }
  }
  
  private async processEmailJob(job: any): Promise<void> {
    const { type, data } = job.data;
    console.log(`ğŸ“§ å¤„ç†é‚®ä»¶ä»»åŠ¡: ${type}`);
    
    // æ¨¡æ‹Ÿé‚®ä»¶å‘é€
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (Math.random() > 0.8) {
      throw new Error('é‚®ä»¶å‘é€å¤±è´¥'); // æ¨¡æ‹Ÿå¤±è´¥
    }
  }
  
  private async processNotificationJob(job: any): Promise<void> {
    const { type, data } = job.data;
    console.log(`ğŸ”” å¤„ç†é€šçŸ¥ä»»åŠ¡: ${type}`);
    
    // æ¨¡æ‹Ÿé€šçŸ¥å‘é€
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  private async processAnalyticsJob(job: any): Promise<void> {
    const { type, data } = job.data;
    console.log(`ğŸ“Š å¤„ç†åˆ†æä»»åŠ¡: ${type}`);
    
    // æ¨¡æ‹Ÿæ•°æ®åˆ†æ
    await new Promise(resolve => setTimeout(resolve, 200));
  }
}

// ä½¿ç”¨é˜Ÿåˆ—çš„äº‹ä»¶å¤„ç†å™¨
@Injectable()
export class QueuedEmailService {
  constructor(private readonly queueService: QueueService) {}
  
  @OnEvent('user.registered')
  async handleUserRegistered(event: UserRegisteredEvent) {
    // å°†é‚®ä»¶ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯ç«‹å³å‘é€
    await this.queueService.addJob('email-queue', {
      type: 'welcome-email',
      data: {
        email: event.email,
        username: event.username,
        userId: event.userId,
      },
    });
    
    console.log(`ğŸ“¤ æ¬¢è¿é‚®ä»¶ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—: ${event.email}`);
  }
  
  @OnEvent('order.created')
  async handleOrderCreated(event: OrderCreatedEvent) {
    await this.queueService.addJob('email-queue', {
      type: 'order-confirmation',
      data: {
        orderId: event.orderId,
        userId: event.userId,
        totalAmount: event.totalAmount,
        items: event.items,
      },
    });
    
    console.log(`ğŸ“¤ è®¢å•ç¡®è®¤é‚®ä»¶ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—: ${event.orderId}`);
  }
}
```

#### ğŸ§  é€šä¿¡æœºåˆ¶é€‰æ‹©æŒ‡å—

| é€šä¿¡æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç¤ºä¾‹ |
|----------|----------|------|------|------|
| **åŒæ­¥è°ƒç”¨** | éœ€è¦ç«‹å³ç»“æœã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜ | ç®€å•ç›´æ¥ã€ç»“æœå¯é  | é˜»å¡ä¸»æµç¨‹ã€è€¦åˆåº¦é«˜ | ç”¨æˆ·éªŒè¯ã€åº“å­˜æ£€æŸ¥ |
| **å¼‚æ­¥äº‹ä»¶** | è§£è€¦ä¸šåŠ¡æµç¨‹ã€éå…³é”®è·¯å¾„ | è§£è€¦ã€é«˜æ€§èƒ½ | å¤æ‚åº¦é«˜ã€æœ€ç»ˆä¸€è‡´æ€§ | é‚®ä»¶é€šçŸ¥ã€æ•°æ®ç»Ÿè®¡ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | å¯é æ€§è¦æ±‚é«˜ã€éœ€è¦é‡è¯•æœºåˆ¶ | å¯é ã€å¯é‡è¯• | åŸºç¡€è®¾æ–½å¤æ‚ | æ”¯ä»˜å¤„ç†ã€æ–‡ä»¶å¤„ç† |

**è®°å¿†å£è¯€**ï¼š
> "åŒæ­¥è°ƒç”¨è¦ç»“æœï¼Œå¼‚æ­¥äº‹ä»¶è§£è€¦åˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¿å¯é ï¼Œé€‰æ‹©æ–¹å¼çœ‹åœºæ™¯"