# ç¬¬9.10èŠ‚ éƒ¨ç½²ä¸è¿ç»´

> **ä¸Šçº¿å®æˆ˜** - ä¼ä¸šçº§åº”ç”¨çš„éƒ¨ç½²ä¸è¿ç»´å®è·µ

## ğŸ“š æœ¬èŠ‚å­¦ä¹ ç›®æ ‡

### ğŸ¯ çŸ¥è¯†ç›®æ ‡
- [ ] **æŒæ¡Dockerå®¹å™¨åŒ–éƒ¨ç½²**ï¼šå­¦ä¼šä½¿ç”¨Dockeræ‰“åŒ…å’Œéƒ¨ç½²NestJSåº”ç”¨
- [ ] **ç†è§£äº‘æœåŠ¡å™¨éƒ¨ç½²é…ç½®**ï¼šæŒæ¡åœ¨äº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²åº”ç”¨çš„å®Œæ•´æµç¨‹
- [ ] **å­¦ä¼šç›‘æ§å’Œæ—¥å¿—ç®¡ç†**ï¼šå»ºç«‹å®Œå–„çš„åº”ç”¨ç›‘æ§å’Œæ—¥å¿—æ”¶é›†ç³»ç»Ÿ
- [ ] **æŒæ¡CI/CDè‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šå®ç°ä»ä»£ç æäº¤åˆ°è‡ªåŠ¨éƒ¨ç½²çš„å®Œæ•´æµç¨‹

### ğŸ› ï¸ æŠ€èƒ½ç›®æ ‡
- [ ] èƒ½å¤Ÿä½¿ç”¨Dockerå®¹å™¨åŒ–éƒ¨ç½²åº”ç”¨
- [ ] èƒ½å¤Ÿåœ¨äº‘æœåŠ¡å™¨ä¸Šé…ç½®ç”Ÿäº§ç¯å¢ƒ
- [ ] èƒ½å¤Ÿå»ºç«‹ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
- [ ] èƒ½å¤Ÿå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

### â° å­¦ä¹ æ—¶é•¿
- **ç†è®ºå­¦ä¹ **ï¼š2-3å°æ—¶
- **å®è·µéƒ¨ç½²**ï¼š4-6å°æ—¶
- **æ€»è®¡æ—¶é•¿**ï¼š6-9å°æ—¶

---

## 9.10.1 Dockerå®¹å™¨åŒ–éƒ¨ç½²

### ğŸ³ Dockeré…ç½®

#### ğŸ“‹ Dockerfileç¼–å†™

**åˆ›å»ºDockerfile**ï¼š
```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM node:18-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production && npm cache clean --force

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# ç”Ÿäº§ç¯å¢ƒé•œåƒ
FROM node:18-alpine AS production

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nestjs -u 1001

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm ci --only=production && npm cache clean --force

# ä»builderé˜¶æ®µå¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder --chown=nestjs:nodejs /app/dist ./dist

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nestjs

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["node", "dist/main"]
```

#### ğŸ”§ Docker Composeé…ç½®

**åˆ›å»ºdocker-compose.yml**ï¼š
```yaml
version: '3.8'

services:
  # åº”ç”¨æœåŠ¡
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: blog-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USERNAME=blog_user
      - DB_PASSWORD=blog_password
      - DB_DATABASE=blog_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - blog-network
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs

  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    container_name: blog-mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=blog_db
      - MYSQL_USER=blog_user
      - MYSQL_PASSWORD=blog_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    networks:
      - blog-network

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: blog-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 20s
      retries: 10
    networks:
      - blog-network

  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: blog-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./docker/nginx/ssl:/etc/nginx/ssl
      - ./uploads:/var/www/uploads
    depends_on:
      - app
    networks:
      - blog-network

volumes:
  mysql_data:
  redis_data:

networks:
  blog-network:
    driver: bridge
```

#### ğŸ”§ Nginxé…ç½®

**åˆ›å»ºdocker/nginx/nginx.conf**ï¼š
```nginx
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    # åŸºæœ¬è®¾ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # ä¸Šæ¸¸æœåŠ¡å™¨
    upstream backend {
        server app:3000;
    }

    # HTTPæœåŠ¡å™¨
    server {
        listen 80;
        server_name localhost;

        # é‡å®šå‘åˆ°HTTPS
        return 301 https://$server_name$request_uri;
    }

    # HTTPSæœåŠ¡å™¨
    server {
        listen 443 ssl http2;
        server_name localhost;

        # SSLé…ç½®
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;

        # ç°ä»£SSLé…ç½®
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # å®‰å…¨å¤´
        add_header Strict-Transport-Security "max-age=63072000" always;
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # APIä»£ç†
        location /api {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # é™æ€æ–‡ä»¶
        location /uploads {
            alias /var/www/uploads;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            proxy_pass http://backend/health;
            access_log off;
        }
    }
}
```

---

## 9.10.2 äº‘æœåŠ¡å™¨éƒ¨ç½²é…ç½®

### â˜ï¸ æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

#### ğŸ–¥ï¸ æœåŠ¡å™¨åŸºç¡€é…ç½®

**1. æ›´æ–°ç³»ç»Ÿ**ï¼š
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

**2. å®‰è£…Docker**ï¼š
```bash
# å®‰è£…Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# æ·»åŠ ç”¨æˆ·åˆ°dockerç»„
sudo usermod -aG docker $USER
```

**3. é…ç½®é˜²ç«å¢™**ï¼š
```bash
# Ubuntu UFW
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

#### ğŸ” SSLè¯ä¹¦é…ç½®

**ä½¿ç”¨Let's Encryptè·å–å…è´¹SSLè¯ä¹¦**ï¼š
```bash
# å®‰è£…Certbot
sudo apt install certbot

# è·å–è¯ä¹¦
sudo certbot certonly --standalone -d yourdomain.com

# å¤åˆ¶è¯ä¹¦åˆ°é¡¹ç›®ç›®å½•
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem ./docker/nginx/ssl/cert.pem
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem ./docker/nginx/ssl/key.pem

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

#### ğŸ“‹ éƒ¨ç½²è„šæœ¬

**åˆ›å»ºdeploy.sh**ï¼š
```bash
#!/bin/bash

set -e

echo "ğŸš€ Starting deployment..."

# æ£€æŸ¥ç¯å¢ƒå˜é‡
if [ ! -f .env.production ]; then
    echo "âŒ .env.production file not found"
    exit 1
fi

# åŠ è½½ç¯å¢ƒå˜é‡
export $(cat .env.production | xargs)

# æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ Pulling latest code..."
git pull origin main

# æ„å»ºé•œåƒ
echo "ğŸ”¨ Building Docker images..."
docker-compose -f docker-compose.prod.yml build --no-cache

# åœæ­¢æ—§å®¹å™¨
echo "ğŸ›‘ Stopping old containers..."
docker-compose -f docker-compose.prod.yml down

# å¯åŠ¨æ–°å®¹å™¨
echo "ğŸš€ Starting new containers..."
docker-compose -f docker-compose.prod.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ Waiting for services to start..."
sleep 30

# å¥åº·æ£€æŸ¥
echo "ğŸ” Performing health check..."
if curl -f http://localhost/health; then
    echo "âœ… Deployment successful!"
else
    echo "âŒ Health check failed"
    docker-compose -f docker-compose.prod.yml logs
    exit 1
fi

# æ¸…ç†æ—§é•œåƒ
echo "ğŸ§¹ Cleaning up old images..."
docker image prune -f

echo "ğŸ‰ Deployment completed successfully!"
```

---

## 9.10.3 ç›‘æ§å’Œæ—¥å¿—ç®¡ç†

### ğŸ“Š åº”ç”¨ç›‘æ§

#### ğŸ” å¥åº·æ£€æŸ¥ç«¯ç‚¹

**åˆ›å»ºsrc/health/health.controller.ts**ï¼š
```typescript
import { Controller, Get } from '@nestjs/common';
import { 
  HealthCheckService, 
  HealthCheck,
  TypeOrmHealthIndicator,
  MemoryHealthIndicator,
  DiskHealthIndicator,
} from '@nestjs/terminus';
import { ApiTags, ApiOperation } from '@nestjs/swagger';

@ApiTags('å¥åº·æ£€æŸ¥')
@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private db: TypeOrmHealthIndicator,
    private memory: MemoryHealthIndicator,
    private disk: DiskHealthIndicator,
  ) {}

  @Get()
  @ApiOperation({ summary: 'å¥åº·æ£€æŸ¥' })
  @HealthCheck()
  check() {
    return this.health.check([
      // æ•°æ®åº“æ£€æŸ¥
      () => this.db.pingCheck('database'),
      
      // å†…å­˜æ£€æŸ¥
      () => this.memory.checkHeap('memory_heap', 150 * 1024 * 1024),
      () => this.memory.checkRSS('memory_rss', 150 * 1024 * 1024),
      
      // ç£ç›˜æ£€æŸ¥
      () => this.disk.checkStorage('storage', { 
        path: '/', 
        thresholdPercent: 0.9 
      }),
    ]);
  }

  @Get('ready')
  @ApiOperation({ summary: 'å°±ç»ªæ£€æŸ¥' })
  ready() {
    return { status: 'ready', timestamp: new Date().toISOString() };
  }

  @Get('live')
  @ApiOperation({ summary: 'å­˜æ´»æ£€æŸ¥' })
  live() {
    return { status: 'alive', timestamp: new Date().toISOString() };
  }
}
```

#### ğŸ“ˆ Prometheusç›‘æ§

**åˆ›å»ºdocker/prometheus/prometheus.yml**ï¼š
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'blog-backend'
    static_configs:
      - targets: ['app:3000']
    metrics_path: '/metrics'
    scrape_interval: 5s

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']

  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['mysql-exporter:9104']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

**æ·»åŠ ç›‘æ§æœåŠ¡åˆ°docker-compose.yml**ï¼š
```yaml
  # Prometheusç›‘æ§
  prometheus:
    image: prom/prometheus:latest
    container_name: blog-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - blog-network

  # Grafanaå¯è§†åŒ–
  grafana:
    image: grafana/grafana:latest
    container_name: blog-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./docker/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - blog-network

  # Node Exporter
  node-exporter:
    image: prom/node-exporter:latest
    container_name: blog-node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - blog-network
```

### ğŸ“ æ—¥å¿—ç®¡ç†

#### ğŸ”§ Winstonæ—¥å¿—é…ç½®

**æ›´æ–°src/config/logger.config.ts**ï¼š
```typescript
import { WinstonModuleOptions } from 'nest-winston';
import * as winston from 'winston';
import 'winston-daily-rotate-file';

const logFormat = winston.format.combine(
  winston.format.timestamp(),
  winston.format.errors({ stack: true }),
  winston.format.json(),
);

export const loggerConfig: WinstonModuleOptions = {
  transports: [
    // æ§åˆ¶å°è¾“å‡º
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple(),
      ),
    }),

    // é”™è¯¯æ—¥å¿—æ–‡ä»¶
    new winston.transports.DailyRotateFile({
      filename: 'logs/error-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      level: 'error',
      format: logFormat,
      maxSize: '20m',
      maxFiles: '14d',
    }),

    // åº”ç”¨æ—¥å¿—æ–‡ä»¶
    new winston.transports.DailyRotateFile({
      filename: 'logs/app-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      format: logFormat,
      maxSize: '20m',
      maxFiles: '14d',
    }),

    // è®¿é—®æ—¥å¿—æ–‡ä»¶
    new winston.transports.DailyRotateFile({
      filename: 'logs/access-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      level: 'info',
      format: logFormat,
      maxSize: '20m',
      maxFiles: '30d',
    }),
  ],
};
```

#### ğŸ“Š ELK Stackæ—¥å¿—æ”¶é›†

**åˆ›å»ºdocker/logstash/logstash.conf**ï¼š
```ruby
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "blog-backend" {
    json {
      source => "message"
    }
    
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    mutate {
      add_field => { "service" => "blog-backend" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "blog-backend-%{+YYYY.MM.dd}"
  }
}
```

**æ·»åŠ ELKæœåŠ¡åˆ°docker-compose.yml**ï¼š
```yaml
  # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    container_name: blog-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - blog-network

  # Logstash
  logstash:
    image: docker.elastic.co/logstash/logstash:8.8.0
    container_name: blog-logstash
    ports:
      - "5044:5044"
    volumes:
      - ./docker/logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    depends_on:
      - elasticsearch
    networks:
      - blog-network

  # Kibana
  kibana:
    image: docker.elastic.co/kibana/kibana:8.8.0
    container_name: blog-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    networks:
      - blog-network

  # Filebeat
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.8.0
    container_name: blog-filebeat
    user: root
    volumes:
      - ./docker/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./logs:/var/log/app:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - logstash
    networks:
      - blog-network
```

---

## 9.10.4 CI/CDè‡ªåŠ¨åŒ–éƒ¨ç½²

### ğŸ”„ GitHub Actionséƒ¨ç½²

#### ğŸ“‹ éƒ¨ç½²å·¥ä½œæµ

**åˆ›å»º.github/workflows/deploy.yml**ï¼š
```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm run test:cov
    
    - name: Run e2e tests
      run: npm run test:e2e

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/blog-backend:latest
          ${{ secrets.DOCKER_USERNAME }}/blog-backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /opt/blog-backend
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull origin main
          
          # æ›´æ–°Dockeré•œåƒ
          docker pull ${{ secrets.DOCKER_USERNAME }}/blog-backend:latest
          
          # é‡å¯æœåŠ¡
          docker-compose -f docker-compose.prod.yml down
          docker-compose -f docker-compose.prod.yml up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          if ! curl -f http://localhost/health; then
            echo "Health check failed"
            exit 1
          fi
          
          echo "Deployment successful!"

  notify:
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify deployment status
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

#### ğŸ”§ è“ç»¿éƒ¨ç½²è„šæœ¬

**åˆ›å»ºscripts/blue-green-deploy.sh**ï¼š
```bash
#!/bin/bash

set -e

# é…ç½®
BLUE_PORT=3000
GREEN_PORT=3001
HEALTH_CHECK_URL="http://localhost"
NGINX_CONFIG="/etc/nginx/sites-available/blog-backend"

# æ£€æŸ¥å½“å‰æ´»è·ƒç¯å¢ƒ
get_active_environment() {
    if docker-compose -f docker-compose.blue.yml ps | grep -q "Up"; then
        echo "blue"
    elif docker-compose -f docker-compose.green.yml ps | grep -q "Up"; then
        echo "green"
    else
        echo "none"
    fi
}

# å¥åº·æ£€æŸ¥
health_check() {
    local port=$1
    local max_attempts=30
    local attempt=1
    
    echo "Performing health check on port $port..."
    
    while [ $attempt -le $max_attempts ]; do
        if curl -f "$HEALTH_CHECK_URL:$port/health" >/dev/null 2>&1; then
            echo "Health check passed on port $port"
            return 0
        fi
        
        echo "Attempt $attempt/$max_attempts failed, retrying in 10 seconds..."
        sleep 10
        attempt=$((attempt + 1))
    done
    
    echo "Health check failed on port $port"
    return 1
}

# åˆ‡æ¢Nginxé…ç½®
switch_nginx() {
    local port=$1
    
    echo "Switching Nginx to port $port..."
    
    sed -i "s/server app:[0-9]*/server app:$port/" $NGINX_CONFIG
    nginx -t && nginx -s reload
    
    echo "Nginx switched to port $port"
}

# ä¸»éƒ¨ç½²é€»è¾‘
main() {
    echo "ğŸš€ Starting blue-green deployment..."
    
    # è·å–å½“å‰æ´»è·ƒç¯å¢ƒ
    ACTIVE_ENV=$(get_active_environment)
    echo "Current active environment: $ACTIVE_ENV"
    
    # ç¡®å®šç›®æ ‡ç¯å¢ƒ
    if [ "$ACTIVE_ENV" = "blue" ]; then
        TARGET_ENV="green"
        TARGET_PORT=$GREEN_PORT
        TARGET_COMPOSE="docker-compose.green.yml"
    else
        TARGET_ENV="blue"
        TARGET_PORT=$BLUE_PORT
        TARGET_COMPOSE="docker-compose.blue.yml"
    fi
    
    echo "Deploying to $TARGET_ENV environment on port $TARGET_PORT"
    
    # æ„å»ºæ–°é•œåƒ
    echo "Building new Docker image..."
    docker-compose -f $TARGET_COMPOSE build
    
    # å¯åŠ¨ç›®æ ‡ç¯å¢ƒ
    echo "Starting $TARGET_ENV environment..."
    docker-compose -f $TARGET_COMPOSE up -d
    
    # å¥åº·æ£€æŸ¥
    if health_check $TARGET_PORT; then
        echo "âœ… $TARGET_ENV environment is healthy"
        
        # åˆ‡æ¢æµé‡
        switch_nginx $TARGET_PORT
        
        # åœæ­¢æ—§ç¯å¢ƒ
        if [ "$ACTIVE_ENV" != "none" ]; then
            echo "Stopping $ACTIVE_ENV environment..."
            if [ "$ACTIVE_ENV" = "blue" ]; then
                docker-compose -f docker-compose.blue.yml down
            else
                docker-compose -f docker-compose.green.yml down
            fi
        fi
        
        echo "ğŸ‰ Deployment completed successfully!"
        echo "Active environment: $TARGET_ENV"
        
    else
        echo "âŒ Health check failed, rolling back..."
        docker-compose -f $TARGET_COMPOSE down
        exit 1
    fi
}

# å›æ»šå‡½æ•°
rollback() {
    echo "ğŸ”„ Rolling back deployment..."
    
    ACTIVE_ENV=$(get_active_environment)
    
    if [ "$ACTIVE_ENV" = "blue" ]; then
        ROLLBACK_ENV="green"
        ROLLBACK_PORT=$GREEN_PORT
        ROLLBACK_COMPOSE="docker-compose.green.yml"
    else
        ROLLBACK_ENV="blue"
        ROLLBACK_PORT=$BLUE_PORT
        ROLLBACK_COMPOSE="docker-compose.blue.yml"
    fi
    
    # å¯åŠ¨å›æ»šç¯å¢ƒ
    docker-compose -f $ROLLBACK_COMPOSE up -d
    
    # å¥åº·æ£€æŸ¥
    if health_check $ROLLBACK_PORT; then
        switch_nginx $ROLLBACK_PORT
        echo "âœ… Rollback completed successfully!"
    else
        echo "âŒ Rollback failed!"
        exit 1
    fi
}

# å¤„ç†å‘½ä»¤è¡Œå‚æ•°
case "${1:-deploy}" in
    "deploy")
        main
        ;;
    "rollback")
        rollback
        ;;
    *)
        echo "Usage: $0 [deploy|rollback]"
        exit 1
        ;;
esac
```

---

## ğŸ“Š æœ¬èŠ‚æ€»ç»“

### ğŸ¯ å…³é”®è¦ç‚¹å›é¡¾

1. **å®¹å™¨åŒ–éƒ¨ç½²è¦æ ‡å‡†åŒ–**
   - ä½¿ç”¨Dockerå¤šé˜¶æ®µæ„å»º
   - é…ç½®å®Œæ•´çš„docker-compose
   - å®ç°æœåŠ¡ç¼–æ’å’Œä¾èµ–ç®¡ç†

2. **äº‘æœåŠ¡å™¨éƒ¨ç½²è¦å®‰å…¨å¯é **
   - é…ç½®é˜²ç«å¢™å’ŒSSLè¯ä¹¦
   - ä½¿ç”¨Nginxåå‘ä»£ç†
   - å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

3. **ç›‘æ§æ—¥å¿—è¦å…¨é¢è¦†ç›–**
   - å¥åº·æ£€æŸ¥å’Œæ€§èƒ½ç›‘æ§
   - é›†ä¸­åŒ–æ—¥å¿—æ”¶é›†å’Œåˆ†æ
   - å‘Šè­¦å’Œé€šçŸ¥æœºåˆ¶

4. **CI/CDè¦è‡ªåŠ¨åŒ–å®Œæ•´**
   - è‡ªåŠ¨åŒ–æµ‹è¯•å’Œæ„å»º
   - è“ç»¿éƒ¨ç½²å’Œå›æ»šæœºåˆ¶
   - éƒ¨ç½²çŠ¶æ€é€šçŸ¥

### ğŸ“ å®è·µç»ƒä¹ 

#### ç»ƒä¹ 1ï¼šå®Œæ•´éƒ¨ç½²æµç¨‹
**ä»»åŠ¡**ï¼šå®ç°å®Œæ•´çš„å®¹å™¨åŒ–éƒ¨ç½²
**è¦æ±‚**ï¼š
- ç¼–å†™Dockerfileå’Œdocker-compose
- é…ç½®Nginxåå‘ä»£ç†
- å®ç°å¥åº·æ£€æŸ¥
- éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨

#### ç»ƒä¹ 2ï¼šç›‘æ§ç³»ç»Ÿæ­å»º
**ä»»åŠ¡**ï¼šæ­å»ºå®Œæ•´çš„ç›‘æ§ç³»ç»Ÿ
**è¦æ±‚**ï¼š
- é…ç½®Prometheusç›‘æ§
- è®¾ç½®Grafanaä»ªè¡¨æ¿
- å®ç°æ—¥å¿—æ”¶é›†
- é…ç½®å‘Šè­¦è§„åˆ™

#### ç»ƒä¹ 3ï¼šCI/CDæµç¨‹ä¼˜åŒ–
**ä»»åŠ¡**ï¼šä¼˜åŒ–è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
**è¦æ±‚**ï¼š
- å®ç°è“ç»¿éƒ¨ç½²
- æ·»åŠ è‡ªåŠ¨å›æ»š
- é…ç½®éƒ¨ç½²é€šçŸ¥
- ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦

### ğŸ” è‡ªæˆ‘æ£€æµ‹

- [ ] æˆ‘èƒ½å¤Ÿä½¿ç”¨Dockerå®¹å™¨åŒ–éƒ¨ç½²åº”ç”¨
- [ ] æˆ‘ç†è§£äº‘æœåŠ¡å™¨çš„éƒ¨ç½²é…ç½®
- [ ] æˆ‘æŒæ¡äº†ç›‘æ§å’Œæ—¥å¿—ç®¡ç†
- [ ] æˆ‘äº†è§£CI/CDè‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

### ğŸ¯ å­¦ä¹ æˆæœ

å®Œæˆç¬¬9ç« å­¦ä¹ åï¼Œä½ å·²ç»æŒæ¡äº†ï¼š
- âœ… ä¼ä¸šçº§åšå®¢ç³»ç»Ÿçš„å®Œæ•´å¼€å‘æµç¨‹
- âœ… ä»éœ€æ±‚åˆ†æåˆ°éƒ¨ç½²ä¸Šçº¿çš„å…¨æ ˆæŠ€èƒ½
- âœ… NestJSæ¡†æ¶çš„æ·±åº¦åº”ç”¨å’Œæœ€ä½³å®è·µ
- âœ… ç°ä»£åŒ–çš„å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²å·¥å…·é“¾

**æ­å–œä½ å®Œæˆäº†ç¬¬9ç« çš„å­¦ä¹ ï¼** ğŸ‰

ä½ ç°åœ¨å·²ç»å…·å¤‡äº†ï¼š
- ğŸ—ï¸ **æ¶æ„è®¾è®¡èƒ½åŠ›**ï¼šèƒ½å¤Ÿè®¾è®¡ä¼ä¸šçº§åº”ç”¨æ¶æ„
- ğŸ’» **å…¨æ ˆå¼€å‘æŠ€èƒ½**ï¼šæŒæ¡åç«¯å¼€å‘çš„å®Œæ•´æŠ€æœ¯æ ˆ
- ğŸ”§ **å·¥ç¨‹åŒ–å®è·µ**ï¼šå…·å¤‡ç°ä»£åŒ–çš„å¼€å‘å’Œéƒ¨ç½²èƒ½åŠ›
- ğŸ“Š **è¿ç»´ç›‘æ§ç»éªŒ**ï¼šäº†è§£ç”Ÿäº§ç¯å¢ƒçš„è¿ç»´è¦æ±‚

**ç»§ç»­ä½ çš„å­¦ä¹ ä¹‹æ—…ï¼Œæ¢ç´¢æ›´å¤šé«˜çº§ä¸»é¢˜ï¼** ğŸš€ 