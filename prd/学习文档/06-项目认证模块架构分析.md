# é¡¹ç›®è®¤è¯æ¨¡å—æ¶æ„æ·±åº¦åˆ†æ

> è§£æ„æˆ‘ä»¬çš„åšå®¢åç«¯è®¤è¯ç³»ç»Ÿ - æ¯ä¸ªæ¨¡å—çš„ä½œç”¨ã€è®¾è®¡æ€è·¯å’Œå®ç°ç»†èŠ‚

## ğŸ¯ æ¦‚è¿°ï¼šæˆ‘ä»¬çš„è®¤è¯ç³»ç»Ÿæ¶æ„

æˆ‘ä»¬çš„è®¤è¯ç³»ç»Ÿé‡‡ç”¨äº†åˆ†å±‚æ¶æ„å’Œæ¨¡å—åŒ–è®¾è®¡ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ•´ä½“æ¶æ„ï¼š

```
src/auth/
â”œâ”€â”€ auth.module.ts          # æ¨¡å—é…ç½®å’Œä¾èµ–ç®¡ç†
â”œâ”€â”€ auth.controller.ts      # HTTPæ¥å£å±‚
â”œâ”€â”€ auth.service.ts         # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ strategies/
â”‚   â””â”€â”€ jwt.strategy.ts     # JWTéªŒè¯ç­–ç•¥
â”œâ”€â”€ guards/
â”‚   â””â”€â”€ jwt-auth.guard.ts   # è·¯ç”±å®ˆå«
â”œâ”€â”€ decorators/
â”‚   â”œâ”€â”€ public.decorator.ts      # å…¬å¼€è·¯ç”±è£…é¥°å™¨
â”‚   â””â”€â”€ current-user.decorator.ts # å½“å‰ç”¨æˆ·è£…é¥°å™¨
â””â”€â”€ dto/
    â””â”€â”€ login.dto.ts        # æ•°æ®ä¼ è¾“å¯¹è±¡
```

**è®¾è®¡ç†å¿µ**ï¼šæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰å•ä¸€èŒè´£ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥å®ç°æ¨¡å—é—´çš„è§£è€¦ã€‚

## ğŸ”§ AuthModuleï¼šç³»ç»Ÿçš„é…ç½®ä¸­æ¢

### æ–‡ä»¶ä½ç½®ï¼š`src/auth/auth.module.ts`

```typescript
@Module({
  imports: [
    TypeOrmModule.forFeature([User]),        // 1. æ•°æ®åº“è¿æ¥
    PassportModule.register({ defaultStrategy: 'jwt' }), // 2. è®¤è¯ç­–ç•¥
    JwtModule.register({                     // 3. JWTé…ç½®
      secret: process.env.JWT_SECRET || 'your-secret-key',
      signOptions: {
        expiresIn: '24h',
      },
    }),
  ],
  controllers: [AuthController],             // 4. æ§åˆ¶å™¨æ³¨å†Œ
  providers: [AuthService, JwtStrategy],     // 5. æœåŠ¡æ³¨å†Œ
  exports: [AuthService, JwtStrategy, PassportModule], // 6. æœåŠ¡å¯¼å‡º
})
export class AuthModule {}
```

### æ¨¡å—è§£æ

#### 1. imports - ä¾èµ–å¯¼å…¥
```typescript
TypeOrmModule.forFeature([User])
```
**ä½œç”¨**ï¼šæ³¨å†ŒUserå®ä½“ï¼Œä½¿å¾—AuthServiceå¯ä»¥æ³¨å…¥UserRepository  
**å‰ç«¯ç±»æ¯”**ï¼šåƒæ˜¯å¯¼å…¥æ•°æ®åº“è¿æ¥hook
```tsx
import { useDatabase } from './hooks/useDatabase';
```

```typescript
PassportModule.register({ defaultStrategy: 'jwt' })
```
**ä½œç”¨**ï¼šé…ç½®Passportè®¤è¯åº“ï¼Œè®¾ç½®é»˜è®¤ç­–ç•¥ä¸ºJWT  
**å‰ç«¯ç±»æ¯”**ï¼šé…ç½®å…¨å±€è®¤è¯ä¸Šä¸‹æ–‡
```tsx
<AuthProvider defaultStrategy="jwt">
  <App />
</AuthProvider>
```

```typescript
JwtModule.register({...})
```
**ä½œç”¨**ï¼šé…ç½®JWTç­¾åå¯†é’¥å’Œè¿‡æœŸæ—¶é—´  
**å‰ç«¯ç±»æ¯”**ï¼šé…ç½®Tokenç®¡ç†å‚æ•°
```tsx
const tokenConfig = {
  secretKey: process.env.REACT_APP_JWT_SECRET,
  expirationTime: '24h'
};
```

#### 2. providers - æœåŠ¡æ³¨å†Œ
å°†AuthServiceå’ŒJwtStrategyæ³¨å†Œåˆ°ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œä½¿å®ƒä»¬å¯ä»¥è¢«è‡ªåŠ¨æ³¨å…¥åˆ°å…¶ä»–ç±»ä¸­ã€‚

#### 3. exports - æœåŠ¡å¯¼å‡º
å¯¼å‡ºçš„æœåŠ¡å¯ä»¥è¢«å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼Œå®ç°æ¨¡å—é—´çš„é€šä¿¡ã€‚

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… **é…ç½®é›†ä¸­**ï¼šæ‰€æœ‰è®¤è¯ç›¸å…³é…ç½®éƒ½åœ¨ä¸€å¤„
- âœ… **ä¾èµ–æ¸…æ™°**ï¼šæ˜ç¡®å£°æ˜éœ€è¦ä»€ä¹ˆå¤–éƒ¨èµ„æº
- âœ… **æœåŠ¡éš”ç¦»**ï¼šé€šè¿‡exportsæ§åˆ¶æœåŠ¡çš„å¯è§æ€§
- âœ… **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥è½»æ¾æ›¿æ¢ä¾èµ–è¿›è¡Œå•å…ƒæµ‹è¯•

## ğŸŒ AuthControllerï¼šHTTPæ¥å£çš„é—¨é¢

### æ–‡ä»¶ä½ç½®ï¼š`src/auth/auth.controller.ts`

```typescript
@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @Post('login')
  @HttpCode(HttpStatus.OK)
  async login(@Body() loginDto: LoginDto): Promise<LoginResponse> {
    return await this.authService.login(loginDto);
  }
}
```

### æ§åˆ¶å™¨è§£æ

#### èŒè´£è¾¹ç•Œ
- âœ… **HTTPå±‚å¤„ç†**ï¼šå¤„ç†è¯·æ±‚å’Œå“åº”
- âœ… **æ•°æ®éªŒè¯**ï¼šé€šè¿‡DTOéªŒè¯è¾“å…¥æ•°æ®
- âœ… **ä¸šåŠ¡å§”æ‰˜**ï¼šå°†å…·ä½“ä¸šåŠ¡é€»è¾‘å§”æ‰˜ç»™Service
- âŒ **ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘**ï¼šä¿æŒè½»è–„

#### è£…é¥°å™¨è§£æ

```typescript
@Controller('auth')
```
**ä½œç”¨**ï¼šå®šä¹‰æ§åˆ¶å™¨çš„åŸºç¡€è·¯å¾„ä¸º `/auth`  
**å‰ç«¯ç±»æ¯”**ï¼šå®šä¹‰è·¯ç”±ç»„ä»¶çš„åŸºç¡€è·¯å¾„
```tsx
<Route path="/auth">
  <AuthRoutes />
</Route>
```

```typescript
@Post('login')
```
**ä½œç”¨**ï¼šå®šä¹‰POSTè¯·æ±‚è·¯å¾„ä¸º `/auth/login`  
**å‰ç«¯ç±»æ¯”**ï¼šå®šä¹‰å…·ä½“çš„è·¯ç”±å¤„ç†
```tsx
<Route path="/auth/login" element={<LoginForm />} />
```

```typescript
@HttpCode(HttpStatus.OK)
```
**ä½œç”¨**ï¼šè®¾ç½®æˆåŠŸå“åº”çš„HTTPçŠ¶æ€ç ä¸º200  
**è®¾è®¡æ€è€ƒ**ï¼šç™»å½•æˆåŠŸè¿”å›200è€Œä¸æ˜¯201ï¼ˆåˆ›å»ºèµ„æºï¼‰ï¼Œç¬¦åˆRESTfulè§„èŒƒ

```typescript
@Body() loginDto: LoginDto
```
**ä½œç”¨**ï¼šå°†è¯·æ±‚ä½“æ•°æ®ç»‘å®šåˆ°LoginDtoå¯¹è±¡ï¼Œå¹¶è¿›è¡ŒéªŒè¯  
**å‰ç«¯ç±»æ¯”**ï¼šè¡¨å•æ•°æ®éªŒè¯
```tsx
const { register, handleSubmit, formState: { errors } } = useForm<LoginDto>();
```

#### é”™è¯¯å¤„ç†ç­–ç•¥
æ§åˆ¶å™¨ä¸å¤„ç†å…·ä½“çš„ä¸šåŠ¡å¼‚å¸¸ï¼Œè®©Serviceå±‚æŠ›å‡ºçš„å¼‚å¸¸è‡ªç„¶å†’æ³¡åˆ°å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ã€‚

**å‰ç«¯å¯¹æ¯”**ï¼š
```tsx
// å‰ç«¯æ§åˆ¶å™¨ç±»æ¯”
const AuthController = () => {
  const authService = useAuthService();
  
  const handleLogin = async (data: LoginDto) => {
    try {
      const result = await authService.login(data);
      // åªå¤„ç†æˆåŠŸæƒ…å†µï¼Œé”™è¯¯è®©å…¨å±€é”™è¯¯è¾¹ç•Œå¤„ç†
      return result;
    } catch (error) {
      throw error; // ä¸åœ¨è¿™é‡Œå¤„ç†é”™è¯¯
    }
  };
  
  return <LoginForm onSubmit={handleLogin} />;
};
```

## ğŸ’¼ AuthServiceï¼šä¸šåŠ¡é€»è¾‘çš„æ ¸å¿ƒ

### æ–‡ä»¶ä½ç½®ï¼š`src/auth/auth.service.ts`

```typescript
@Injectable()
export class AuthService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>,
    private jwtService: JwtService,
  ) {}

  async login(loginDto: LoginDto): Promise<LoginResponse> {
    // ä¸šåŠ¡é€»è¾‘å®ç°
  }
}
```

### æœåŠ¡è§£æ

#### ä¾èµ–æ³¨å…¥åˆ†æ

```typescript
@InjectRepository(User)
private userRepository: Repository<User>
```
**ä½œç”¨**ï¼šæ³¨å…¥Userå®ä½“çš„Repositoryï¼Œç”¨äºæ•°æ®åº“æ“ä½œ  
**è®¾è®¡æ¨¡å¼**ï¼šRepositoryæ¨¡å¼ï¼Œå°†æ•°æ®è®¿é—®é€»è¾‘å°è£…  
**å‰ç«¯ç±»æ¯”**ï¼šæ³¨å…¥æ•°æ®è®¿é—®hook
```tsx
const userApi = useUserApi(); // å°è£…ç”¨æˆ·ç›¸å…³APIè°ƒç”¨
```

```typescript
private jwtService: JwtService
```
**ä½œç”¨**ï¼šæ³¨å…¥JWTæœåŠ¡ï¼Œç”¨äºTokençš„ç”Ÿæˆå’ŒéªŒè¯  
**å‰ç«¯ç±»æ¯”**ï¼šæ³¨å…¥Tokenç®¡ç†å·¥å…·
```tsx
const tokenManager = useTokenManager();
```

#### ä¸šåŠ¡æµç¨‹åˆ†æ

æˆ‘ä»¬çš„loginæ–¹æ³•å®ç°äº†å®Œæ•´çš„è®¤è¯æµç¨‹ï¼š

```typescript
async login(loginDto: LoginDto): Promise<LoginResponse> {
  // 1. ç”¨æˆ·æŸ¥æ‰¾
  const user = await this.userRepository.findOne({
    where: { email: loginDto.email },
  });

  // 2. ç”¨æˆ·å­˜åœ¨æ€§éªŒè¯
  if (!user) {
    throw new UnauthorizedException('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
  }

  // 3. å¯†ç éªŒè¯
  const isPasswordValid = await bcrypt.compare(loginDto.password, user.password);
  if (!isPasswordValid) {
    throw new UnauthorizedException('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
  }

  // 4. ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
  if (user.status !== 'active') {
    throw new UnauthorizedException('è´¦æˆ·å·²è¢«ç¦ç”¨');
  }

  // 5. ä¸šåŠ¡é€»è¾‘å¤„ç†
  user.lastLoginAt = new Date();
  await this.userRepository.save(user);

  // 6. Tokenç”Ÿæˆ
  const payload: JwtPayload = {
    userId: user.id,
    username: user.username,
    email: user.email,
  };
  const accessToken = this.jwtService.sign(payload);

  // 7. å“åº”å°è£…
  return {
    accessToken,
    user: {
      id: user.id,
      username: user.username,
      email: user.email,
      role: user.role,
    },
  };
}
```

#### æ¯ä¸ªæ­¥éª¤çš„è®¾è®¡æ€è€ƒ

**æ­¥éª¤1-2ï¼šç”¨æˆ·æŸ¥æ‰¾å’ŒéªŒè¯**
- ä½¿ç”¨é‚®ç®±è€Œéç”¨æˆ·åæŸ¥æ‰¾ï¼Œæ›´ç¬¦åˆç°ä»£åº”ç”¨ä¹ æƒ¯
- ç”¨æˆ·ä¸å­˜åœ¨æ—¶è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯ï¼Œé˜²æ­¢é‚®ç®±æšä¸¾æ”»å‡»

**æ­¥éª¤3ï¼šå¯†ç éªŒè¯**
- ä½¿ç”¨bcrypt.compareè¿›è¡Œå®‰å…¨çš„å¯†ç æ¯”è¾ƒ
- å¯†ç é”™è¯¯æ—¶è¿”å›å’Œç”¨æˆ·ä¸å­˜åœ¨ç›¸åŒçš„é”™è¯¯ä¿¡æ¯ï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²

**æ­¥éª¤4ï¼šçŠ¶æ€æ£€æŸ¥**
- æ”¯æŒç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼Œä¾¿äºç®¡ç†å‘˜æ§åˆ¶ç”¨æˆ·æƒé™
- é¢„ç•™äº†ç”¨æˆ·ç¦ç”¨åŠŸèƒ½çš„å®ç°

**æ­¥éª¤5ï¼šä¸šåŠ¡é€»è¾‘**
- æ›´æ–°æœ€åç™»å½•æ—¶é—´ï¼Œä¾¿äºç”¨æˆ·æ´»è·ƒåº¦åˆ†æ
- è¿™é‡Œå¯ä»¥æ‰©å±•æ›´å¤šç™»å½•ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

**æ­¥éª¤6ï¼šTokenç”Ÿæˆ**
- åªåœ¨payloadä¸­åŒ…å«å¿…è¦ä¿¡æ¯ï¼Œé¿å…Tokenè¿‡å¤§
- ä½¿ç”¨æ˜ç¡®çš„JwtPayloadæ¥å£ï¼Œä¿è¯ç±»å‹å®‰å…¨

**æ­¥éª¤7ï¼šå“åº”å°è£…**
- è¿”å›Tokenå’Œç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- ä¸è¿”å›æ•æ„Ÿä¿¡æ¯å¦‚å¯†ç 

**å‰ç«¯ä¸šåŠ¡é€»è¾‘å¯¹æ¯”**ï¼š
```tsx
const useAuthService = () => {
  const userApi = useUserApi();
  const tokenManager = useTokenManager();
  
  const login = async (credentials: LoginDto) => {
    // 1. å‰ç«¯éªŒè¯
    validateCredentials(credentials);
    
    // 2. å‘é€è¯·æ±‚
    const response = await userApi.login(credentials);
    
    // 3. å¤„ç†å“åº”
    if (response.accessToken) {
      tokenManager.setToken(response.accessToken);
      userStore.setUser(response.user);
      
      // 4. ä¸šåŠ¡é€»è¾‘
      navigate('/dashboard');
      analytics.track('user_login', { userId: response.user.id });
    }
    
    return response;
  };
  
  return { login };
};
```

## ğŸ›¡ï¸ JwtStrategyï¼šTokenéªŒè¯çš„å®ˆæŠ¤è€…

### æ–‡ä»¶ä½ç½®ï¼š`src/auth/strategies/jwt.strategy.ts`

```typescript
@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>,
  ) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: process.env.JWT_SECRET || 'your-secret-key',
    });
  }

  async validate(payload: JwtPayload): Promise<User> {
    // éªŒè¯é€»è¾‘
  }
}
```

### ç­–ç•¥è§£æ

#### ç»§æ‰¿å’Œé…ç½®

```typescript
extends PassportStrategy(Strategy)
```
**ä½œç”¨**ï¼šç»§æ‰¿Passportçš„JWTç­–ç•¥ï¼Œé›†æˆåˆ°NestJSçš„è®¤è¯ä½“ç³»  
**è®¾è®¡æ¨¡å¼**ï¼šç­–ç•¥æ¨¡å¼ï¼Œå¯ä»¥è½»æ¾åˆ‡æ¢ä¸åŒçš„è®¤è¯ç­–ç•¥

#### é…ç½®å‚æ•°è§£æ

```typescript
jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken()
```
**ä½œç”¨**ï¼šæŒ‡å®šä»HTTPå¤´éƒ¨çš„Authorizationå­—æ®µæå–Bearer Token  
**æ ¼å¼**ï¼š`Authorization: Bearer <token>`  
**å‰ç«¯é…ç½®**ï¼š
```tsx
const apiCall = (url, options = {}) => {
  const token = localStorage.getItem('token');
  return fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${token}` // è¿™é‡Œçš„æ ¼å¼
    }
  });
};
```

```typescript
ignoreExpiration: false
```
**ä½œç”¨**ï¼šä¸å¿½ç•¥Tokenè¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸçš„Tokenä¼šè¢«æ‹’ç»  
**å®‰å…¨è€ƒè™‘**ï¼šå¼ºåˆ¶Tokenè¿‡æœŸï¼Œæé«˜å®‰å…¨æ€§

```typescript
secretOrKey: process.env.JWT_SECRET
```
**ä½œç”¨**ï¼šæŒ‡å®šéªŒè¯Tokenç­¾åçš„å¯†é’¥  
**å®‰å…¨è¦æ±‚**ï¼šå¿…é¡»ä¸ç­¾å‘Tokenæ—¶ä½¿ç”¨çš„å¯†é’¥ä¸€è‡´

#### éªŒè¯æµç¨‹æ·±åº¦è§£æ

```typescript
async validate(payload: JwtPayload): Promise<User> {
  const { userId } = payload;
  
  // æ•°æ®åº“å†æ¬¡éªŒè¯
  const user = await this.userRepository.findOne({
    where: { id: userId },
  });

  if (!user) {
    throw new UnauthorizedException('ç”¨æˆ·ä¸å­˜åœ¨');
  }

  if (user.status !== 'active') {
    throw new UnauthorizedException('ç”¨æˆ·å·²è¢«ç¦ç”¨');
  }

  return user;
}
```

**ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“éªŒè¯ï¼Ÿ**

JWT Tokenæ˜¯è‡ªåŒ…å«çš„ï¼Œä½†ç”¨æˆ·çŠ¶æ€å¯èƒ½åœ¨Tokenæœ‰æ•ˆæœŸå†…å‘ç”Ÿå˜åŒ–ï¼š

1. **ç”¨æˆ·è¢«åˆ é™¤**ï¼šç®¡ç†å‘˜åˆ é™¤äº†ç”¨æˆ·è´¦æˆ·
2. **ç”¨æˆ·è¢«ç¦ç”¨**ï¼šç®¡ç†å‘˜ç¦ç”¨äº†ç”¨æˆ·è´¦æˆ·
3. **æƒé™å˜æ›´**ï¼šç”¨æˆ·çš„è§’è‰²æˆ–æƒé™å‘ç”Ÿäº†å˜åŒ–
4. **å¼ºåˆ¶ä¸‹çº¿**ï¼šéœ€è¦ç«‹å³ä½¿ç”¨æˆ·ä¸‹çº¿

**æ€§èƒ½ vs å®‰å…¨çš„æƒè¡¡**ï¼š
- âœ… **å®‰å…¨æ€§**ï¼šç¡®ä¿ç”¨æˆ·çŠ¶æ€å®æ—¶æœ‰æ•ˆ
- âŒ **æ€§èƒ½å½±å“**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦æŸ¥è¯¢æ•°æ®åº“
- ğŸ’¡ **ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šå¯ä»¥ä½¿ç”¨Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯

**å‰ç«¯çŠ¶æ€åŒæ­¥**ï¼š
```tsx
// å‰ç«¯ä¹Ÿéœ€è¦å¤„ç†ç”¨æˆ·çŠ¶æ€å˜åŒ–
const useAuthStatus = () => {
  const checkAuthStatus = async () => {
    try {
      const user = await api.getProfile(); // è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
      if (user.status !== 'active') {
        // ç”¨æˆ·è¢«ç¦ç”¨ï¼Œæ¸…é™¤æœ¬åœ°çŠ¶æ€
        localStorage.removeItem('token');
        navigate('/login');
      }
    } catch (error) {
      // Tokenæ— æ•ˆæˆ–å…¶ä»–é”™è¯¯
      localStorage.removeItem('token');
      navigate('/login');
    }
  };
  
  // å®šæœŸæ£€æŸ¥æˆ–åœ¨å…³é”®æ“ä½œå‰æ£€æŸ¥
  useEffect(() => {
    const interval = setInterval(checkAuthStatus, 5 * 60 * 1000); // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    return () => clearInterval(interval);
  }, []);
  
  return { checkAuthStatus };
};
```

## ğŸšª JwtAuthGuardï¼šè·¯ç”±å®ˆå«

### æ–‡ä»¶ä½ç½®ï¼š`src/auth/guards/jwt-auth.guard.ts`

```typescript
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  constructor(private reflector: Reflector) {
    super();
  }

  canActivate(context: ExecutionContext) {
    // æ£€æŸ¥å…¬å¼€è·¯ç”±
    const isPublic = this.reflector.getAllAndOverride<boolean>('isPublic', [
      context.getHandler(),
      context.getClass(),
    ]);

    if (isPublic) {
      return true;
    }

    return super.canActivate(context);
  }
}
```

### å®ˆå«è§£æ

#### ç»§æ‰¿å’Œå¢å¼º

```typescript
extends AuthGuard('jwt')
```
**ä½œç”¨**ï¼šç»§æ‰¿Passportçš„JWTå®ˆå«ï¼Œå¹¶æ·»åŠ è‡ªå®šä¹‰é€»è¾‘  
**åŸºç¡€åŠŸèƒ½**ï¼šè‡ªåŠ¨è°ƒç”¨JwtStrategyè¿›è¡ŒTokenéªŒè¯

#### åå°„æœºåˆ¶ä½¿ç”¨

```typescript
this.reflector.getAllAndOverride<boolean>('isPublic', [
  context.getHandler(),    // æ–¹æ³•çº§åˆ«è£…é¥°å™¨
  context.getClass(),      // ç±»çº§åˆ«è£…é¥°å™¨
])
```

**ä½œç”¨**ï¼šæ£€æŸ¥å½“å‰å¤„ç†çš„æ–¹æ³•æˆ–ç±»æ˜¯å¦æœ‰@Publicè£…é¥°å™¨  
**ä¼˜å…ˆçº§**ï¼šæ–¹æ³•çº§åˆ«è£…é¥°å™¨ä¼˜å…ˆäºç±»çº§åˆ«è£…é¥°å™¨

#### æ‰§è¡Œæµç¨‹

1. **è£…é¥°å™¨æ£€æŸ¥**ï¼šé¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰@Publicè£…é¥°å™¨
2. **å…¬å¼€è·¯ç”±**ï¼šå¦‚æœæ˜¯å…¬å¼€è·¯ç”±ï¼Œç›´æ¥è¿”å›trueï¼Œå…è®¸è®¿é—®
3. **ä¿æŠ¤è·¯ç”±**ï¼šå¦‚æœéœ€è¦è®¤è¯ï¼Œè°ƒç”¨çˆ¶ç±»çš„canActivateæ–¹æ³•
4. **TokenéªŒè¯**ï¼šçˆ¶ç±»ä¼šè‡ªåŠ¨è°ƒç”¨JwtStrategyè¿›è¡ŒéªŒè¯
5. **ç”¨æˆ·æ³¨å…¥**ï¼šéªŒè¯æˆåŠŸåï¼Œç”¨æˆ·å¯¹è±¡è¢«æ³¨å…¥åˆ°request.userä¸­

**å‰ç«¯è·¯ç”±å®ˆå«å¯¹æ¯”**ï¼š
```tsx
const ProtectedRoute = ({ children, isPublic = false }) => {
  const { isAuthenticated } = useAuth();
  
  // å…¬å¼€è·¯ç”±ç›´æ¥æ¸²æŸ“
  if (isPublic) {
    return children;
  }
  
  // éœ€è¦è®¤è¯çš„è·¯ç”±
  if (!isAuthenticated) {
    return <Navigate to="/login" />;
  }
  
  return children;
};

// ä½¿ç”¨æ–¹å¼
<Routes>
  <Route path="/login" element={
    <ProtectedRoute isPublic>
      <Login />
    </ProtectedRoute>
  } />
  <Route path="/dashboard" element={
    <ProtectedRoute>
      <Dashboard />
    </ProtectedRoute>
  } />
</Routes>
```

## ğŸ·ï¸ è£…é¥°å™¨ç³»ç»Ÿï¼šè¯­æ³•ç³–çš„è‰ºæœ¯

### @Publicè£…é¥°å™¨

#### æ–‡ä»¶ä½ç½®ï¼š`src/auth/decorators/public.decorator.ts`

```typescript
import { SetMetadata } from '@nestjs/common';

export const Public = () => SetMetadata('isPublic', true);
```

**å®ç°åŸç†**ï¼š
- ä½¿ç”¨NestJSçš„SetMetadata APIè®¾ç½®å…ƒæ•°æ®
- åœ¨JwtAuthGuardä¸­é€šè¿‡Reflectorè¯»å–è¿™ä¸ªå…ƒæ•°æ®

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
@Controller('api/articles')
@UseGuards(JwtAuthGuard)  // æ•´ä¸ªæ§åˆ¶å™¨éœ€è¦è®¤è¯
export class ArticleController {
  
  @Get()
  @Public()  // è¿™ä¸ªæ–¹æ³•æ˜¯å…¬å¼€çš„
  async findAll() {
    return this.articleService.findAll();
  }
  
  @Post()
  // è¿™ä¸ªæ–¹æ³•éœ€è¦è®¤è¯ï¼ˆç»§æ‰¿ç±»çº§åˆ«çš„å®ˆå«ï¼‰
  async create(@Body() dto: CreateArticleDto) {
    return this.articleService.create(dto);
  }
}
```

**å‰ç«¯è£…é¥°å™¨æ¨¡å¼**ï¼š
```tsx
// å‰ç«¯å¯ä»¥ç”¨HOCå®ç°ç±»ä¼¼åŠŸèƒ½
const withPublicAccess = (Component) => {
  return function PublicComponent(props) {
    // å…¬å¼€ç»„ä»¶ï¼Œä¸éœ€è¦è®¤è¯æ£€æŸ¥
    return <Component {...props} />;
  };
};

const withAuth = (Component) => {
  return function AuthenticatedComponent(props) {
    const { isAuthenticated } = useAuth();
    
    if (!isAuthenticated) {
      return <Navigate to="/login" />;
    }
    
    return <Component {...props} />;
  };
};

// ä½¿ç”¨è£…é¥°å™¨
const PublicArticleList = withPublicAccess(ArticleList);
const ProtectedCreateArticle = withAuth(CreateArticle);
```

### @CurrentUserè£…é¥°å™¨

#### æ–‡ä»¶ä½ç½®ï¼š`src/auth/decorators/current-user.decorator.ts`

```typescript
import { createParamDecorator, ExecutionContext } from '@nestjs/common';
import { User } from '../../user/entity/user.entity';

export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext): User => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;
  },
);
```

**å®ç°åŸç†**ï¼š
1. ä½¿ç”¨createParamDecoratoråˆ›å»ºå‚æ•°è£…é¥°å™¨
2. ä»HTTPè¯·æ±‚ä¸Šä¸‹æ–‡ä¸­æå–userå¯¹è±¡
3. userå¯¹è±¡æ˜¯ç”±JwtStrategyéªŒè¯é€šè¿‡åæ³¨å…¥çš„

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
@Controller('api/articles')
export class ArticleController {
  
  @Post()
  @UseGuards(JwtAuthGuard)
  async create(
    @Body() dto: CreateArticleDto,
    @CurrentUser() user: User  // è‡ªåŠ¨æ³¨å…¥å½“å‰ç”¨æˆ·
  ) {
    return this.articleService.create(dto, user.id);
  }
}
```

**æ²¡æœ‰è£…é¥°å™¨çš„å®ç°å¯¹æ¯”**ï¼š
```typescript
// æ²¡æœ‰@CurrentUserè£…é¥°å™¨æ—¶çš„å†™æ³•
@Post()
@UseGuards(JwtAuthGuard)
async create(@Body() dto: CreateArticleDto, @Request() req) {
  const user = req.user;  // æ‰‹åŠ¨è·å–ç”¨æˆ·
  if (!user) {
    throw new UnauthorizedException('ç”¨æˆ·æœªè®¤è¯');
  }
  return this.articleService.create(dto, user.id);
}

// æœ‰@CurrentUserè£…é¥°å™¨çš„å†™æ³•
@Post()
@UseGuards(JwtAuthGuard)
async create(@Body() dto: CreateArticleDto, @CurrentUser() user: User) {
  // ç”¨æˆ·å¯¹è±¡è‡ªåŠ¨æ³¨å…¥ï¼Œç±»å‹å®‰å…¨
  return this.articleService.create(dto, user.id);
}
```

**å‰ç«¯ç±»æ¯”**ï¼š
```tsx
// å‰ç«¯çš„ç”¨æˆ·æ³¨å…¥hook
const useCurrentUser = () => {
  const { user } = useAuth();
  return user;
};

// ä½¿ç”¨æ–¹å¼
const CreateArticle = () => {
  const currentUser = useCurrentUser();
  
  const handleSubmit = (data) => {
    // è‡ªåŠ¨è·å¾—å½“å‰ç”¨æˆ·ä¿¡æ¯
    articleApi.create({ ...data, authorId: currentUser.id });
  };
  
  return <ArticleForm onSubmit={handleSubmit} />;
};
```

## ğŸ“Š æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰

### LoginDto

#### æ–‡ä»¶ä½ç½®ï¼š`src/auth/dto/login.dto.ts`

```typescript
import { IsEmail, IsString, MinLength } from 'class-validator';

export class LoginDto {
  @IsEmail({}, { message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' })
  email: string;

  @IsString({ message: 'å¯†ç å¿…é¡»æ˜¯å­—ç¬¦ä¸²' })
  @MinLength(6, { message: 'å¯†ç è‡³å°‘6ä½' })
  password: string;
}
```

### DTOè§£æ

#### éªŒè¯è£…é¥°å™¨

```typescript
@IsEmail({}, { message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' })
```
**ä½œç”¨**ï¼šéªŒè¯é‚®ç®±æ ¼å¼æ˜¯å¦æ­£ç¡®  
**è‡ªå®šä¹‰æ¶ˆæ¯**ï¼šæä¾›ä¸­æ–‡é”™è¯¯æç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒ

```typescript
@IsString({ message: 'å¯†ç å¿…é¡»æ˜¯å­—ç¬¦ä¸²' })
@MinLength(6, { message: 'å¯†ç è‡³å°‘6ä½' })
```
**ä½œç”¨**ï¼šç¡®ä¿å¯†ç æ˜¯å­—ç¬¦ä¸²ä¸”è‡³å°‘6ä½  
**å®‰å…¨è€ƒè™‘**ï¼šæœ€å°é•¿åº¦è¦æ±‚æé«˜å¯†ç å¼ºåº¦

#### éªŒè¯æµç¨‹

1. **è¯·æ±‚æ¥æ”¶**ï¼šæ§åˆ¶å™¨æ¥æ”¶HTTPè¯·æ±‚
2. **æ•°æ®ç»‘å®š**ï¼šå°†è¯·æ±‚ä½“JSONæ•°æ®ç»‘å®šåˆ°DTOå¯¹è±¡
3. **éªŒè¯æ‰§è¡Œ**ï¼šclass-validatorè‡ªåŠ¨æ‰§è¡ŒéªŒè¯è§„åˆ™
4. **é”™è¯¯å¤„ç†**ï¼šéªŒè¯å¤±è´¥æ—¶è‡ªåŠ¨è¿”å›400é”™è¯¯å’Œè¯¦ç»†é”™è¯¯ä¿¡æ¯
5. **æ•°æ®ä¼ é€’**ï¼šéªŒè¯é€šè¿‡åå°†DTOå¯¹è±¡ä¼ é€’ç»™ä¸šåŠ¡é€»è¾‘

**å‰ç«¯è¡¨å•éªŒè¯å¯¹æ¯”**ï¼š
```tsx
import { useForm } from 'react-hook-form';
import { yupResolver } from '@hookform/resolvers/yup';
import * as yup from 'yup';

// å‰ç«¯éªŒè¯è§„åˆ™
const loginSchema = yup.object({
  email: yup
    .string()
    .email('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€')
    .required('é‚®ç®±ä¸èƒ½ä¸ºç©º'),
  password: yup
    .string()
    .min(6, 'å¯†ç è‡³å°‘6ä½')
    .required('å¯†ç ä¸èƒ½ä¸ºç©º'),
});

const LoginForm = () => {
  const { register, handleSubmit, formState: { errors } } = useForm({
    resolver: yupResolver(loginSchema)  // å‰ç«¯éªŒè¯
  });
  
  const onSubmit = async (data) => {
    // æ•°æ®å·²ç»è¿‡å‰ç«¯éªŒè¯
    // åç«¯è¿˜ä¼šå†æ¬¡éªŒè¯ï¼ˆåŒé‡ä¿é™©ï¼‰
    await authApi.login(data);
  };
  
  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input {...register('email')} />
      {errors.email && <span>{errors.email.message}</span>}
      
      <input type="password" {...register('password')} />
      {errors.password && <span>{errors.password.message}</span>}
    </form>
  );
};
```

## ğŸ”— æ¨¡å—é—´çš„åä½œæµç¨‹

è®©æˆ‘ä»¬çœ‹çœ‹ä¸€ä¸ªå®Œæ•´çš„è®¤è¯è¯·æ±‚æ˜¯å¦‚ä½•åœ¨å„ä¸ªæ¨¡å—é—´æµè½¬çš„ï¼š

### ç™»å½•è¯·æ±‚æµç¨‹

```
1. HTTPè¯·æ±‚
   POST /auth/login
   Body: { email: "user@example.com", password: "123456" }
   
2. AuthController.login()
   - æ¥æ”¶HTTPè¯·æ±‚
   - @Body() è£…é¥°å™¨å°†è¯·æ±‚ä½“ç»‘å®šåˆ°LoginDto
   - class-validator è‡ªåŠ¨éªŒè¯DTO
   - è°ƒç”¨ authService.login(loginDto)
   
3. AuthService.login()
   - æŸ¥è¯¢æ•°æ®åº“éªŒè¯ç”¨æˆ·
   - bcrypt.compare éªŒè¯å¯†ç 
   - æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
   - ç”ŸæˆJWT Token
   - è¿”å› LoginResponse
   
4. HTTPå“åº”
   Status: 200
   Body: {
     accessToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6...",
     user: { id: 1, username: "admin", email: "user@example.com", role: "user" }
   }
```

### å—ä¿æŠ¤èµ„æºè®¿é—®æµç¨‹

```
1. HTTPè¯·æ±‚
   POST /api/articles
   Headers: { Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6..." }
   Body: { title: "æ–°æ–‡ç« ", content: "æ–‡ç« å†…å®¹" }
   
2. JwtAuthGuard.canActivate()
   - æ£€æŸ¥ @Public è£…é¥°å™¨ï¼ˆæ— ï¼‰
   - è°ƒç”¨ super.canActivate()ï¼ˆPassport JWTå®ˆå«ï¼‰
   
3. JwtStrategy.validate()
   - æå–Bearer Token
   - éªŒè¯Tokenç­¾å
   - æ£€æŸ¥Tokenè¿‡æœŸ
   - è°ƒç”¨ validate(payload)
   - æŸ¥è¯¢æ•°æ®åº“éªŒè¯ç”¨æˆ·
   - å°†Userå¯¹è±¡æ³¨å…¥åˆ° request.user
   
4. ArticleController.create()
   - @CurrentUser() è£…é¥°å™¨æå– request.user
   - è°ƒç”¨ articleService.create(dto, user.id)
   
5. ä¸šåŠ¡é€»è¾‘å¤„ç†
   - åˆ›å»ºæ–‡ç« 
   - è¿”å›å“åº”
```

## ğŸ’¡ è®¾è®¡æ¨¡å¼æ€»ç»“

æˆ‘ä»¬çš„è®¤è¯ç³»ç»Ÿä½¿ç”¨äº†å¤šç§è®¾è®¡æ¨¡å¼ï¼š

### 1. æ¨¡å—æ¨¡å¼ï¼ˆModule Patternï¼‰
- **AuthModule** å°è£…æ‰€æœ‰è®¤è¯ç›¸å…³çš„ç»„ä»¶
- é€šè¿‡ imports/exports æ§åˆ¶ä¾èµ–å…³ç³»

### 2. ä¾èµ–æ³¨å…¥æ¨¡å¼ï¼ˆDependency Injectionï¼‰
- æ‰€æœ‰æœåŠ¡é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
- ä¾¿äºæµ‹è¯•å’Œç»´æŠ¤

### 3. ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰
- **JwtStrategy** å¯ä»¥è½»æ¾æ›¿æ¢ä¸ºå…¶ä»–è®¤è¯ç­–ç•¥
- æ”¯æŒå¤šç§è®¤è¯æ–¹å¼çš„æ‰©å±•

### 4. å®ˆå«æ¨¡å¼ï¼ˆGuard Patternï¼‰
- **JwtAuthGuard** ç»Ÿä¸€å¤„ç†è·¯ç”±ä¿æŠ¤
- æä¾›å£°æ˜å¼çš„æƒé™æ§åˆ¶

### 5. è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator Patternï¼‰
- **@Public**ã€**@CurrentUser** æä¾›è¯­æ³•ç³–
- æé«˜ä»£ç å¯è¯»æ€§å’Œå¼€å‘æ•ˆç‡

### 6. DTOæ¨¡å¼ï¼ˆData Transfer Objectï¼‰
- **LoginDto** å°è£…æ•°æ®ä¼ è¾“å’ŒéªŒè¯
- ç¡®ä¿æ•°æ®çš„ç±»å‹å®‰å…¨å’Œå®Œæ•´æ€§

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç±»éƒ½æœ‰æ˜ç¡®çš„èŒè´£
2. **ä¾èµ–åè½¬**ï¼šé«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—çš„å…·ä½“å®ç°
3. **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
4. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨TypeScriptæ¥å£å’ŒDTOç¡®ä¿ç±»å‹å®‰å…¨
5. **å®‰å…¨ä¼˜å…ˆ**ï¼šå¤šå±‚éªŒè¯ï¼Œé˜²æ­¢å®‰å…¨æ¼æ´
6. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œå“åº”

è¿™å¥—è®¤è¯ç³»ç»Ÿä¸ä»…åŠŸèƒ½å®Œæ•´ï¼Œè€Œä¸”æ¶æ„æ¸…æ™°ã€æ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚é€šè¿‡æ·±å…¥ç†è§£æ¯ä¸ªæ¨¡å—çš„ä½œç”¨å’Œè®¾è®¡æ€è·¯ï¼Œä½ å¯ä»¥æ„å»ºå‡ºæ›´åŠ ä¼˜ç§€çš„åç«¯åº”ç”¨ï¼ 