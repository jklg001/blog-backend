# æ¨¡å—ç³»ç»Ÿè¯¦è§£

> ç†è§£NestJSçš„æ¨¡å—åŒ–æ€æƒ³ï¼šä»å‰ç«¯çš„ç»„ä»¶åŒ–åˆ°åç«¯çš„æ¨¡å—åŒ–

## ğŸ¯ ä»€ä¹ˆæ˜¯æ¨¡å—ï¼Ÿ

### å‰ç«¯ç»„ä»¶çš„æ¦‚å¿µ
åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œä½ å¯èƒ½è¿™æ ·ç»„ç»‡ä»£ç ï¼š

```tsx
// UserProfile.tsx - ç”¨æˆ·èµ„æ–™ç»„ä»¶
function UserProfile({ userId }) {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    fetchUser(userId).then(setUser);
  }, [userId]);
  
  return <div>{user?.name}</div>;
}

// UserList.tsx - ç”¨æˆ·åˆ—è¡¨ç»„ä»¶
function UserList() {
  const [users, setUsers] = useState([]);
  
  return (
    <div>
      {users.map(user => 
        <UserProfile key={user.id} userId={user.id} />
      )}
    </div>
  );
}
```

### åç«¯æ¨¡å—çš„æ¦‚å¿µ
åœ¨åç«¯ï¼Œæ¨¡å—æ˜¯è¿™æ ·çš„ï¼š

```typescript
// user.module.ts - ç”¨æˆ·æ¨¡å—
@Module({
  imports: [TypeOrmModule.forFeature([User])],    // ä¾èµ–çš„å…¶ä»–æ¨¡å—
  controllers: [UserController],                   // å¤„ç†HTTPè¯·æ±‚
  providers: [UserService],                       // ä¸šåŠ¡é€»è¾‘æœåŠ¡
  exports: [UserService],                         // å¯¹å¤–æš´éœ²çš„æœåŠ¡
})
export class UserModule {}
```

## ğŸ”„ æ¨¡å—åŒ–çš„ç›¸ä¼¼ä¹‹å¤„

| å‰ç«¯ç»„ä»¶ | åç«¯æ¨¡å— | ç›®çš„ |
|---------|---------|------|
| `props` | `imports` | æ¥æ”¶å¤–éƒ¨ä¾èµ– |
| `children` | `providers` | å†…éƒ¨åŠŸèƒ½ç»„ä»¶ |
| `export` | `exports` | å¯¹å¤–æš´éœ²åŠŸèƒ½ |
| ç»„ä»¶ç»„åˆ | æ¨¡å—ç»„åˆ | æ„å»ºå®Œæ•´åº”ç”¨ |

## ğŸ—ï¸ æˆ‘ä»¬é¡¹ç›®çš„æ¨¡å—ç»“æ„

### 1. æ ¹æ¨¡å— (AppModule)

```typescript
// src/app.module.ts
@Module({
  imports: [
    ConfigModule.forRoot(),           // é…ç½®æ¨¡å—
    TypeOrmModule.forRoot({...}),     // æ•°æ®åº“æ¨¡å—
    UserModule,                       // ç”¨æˆ·æ¨¡å—
    ArticleModule                     // æ–‡ç« æ¨¡å—
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

**ç±»æ¯”å‰ç«¯**ï¼šè¿™å°±åƒæ˜¯ä½ çš„ `App.tsx` æ ¹ç»„ä»¶ï¼Œè´Ÿè´£ç»„åˆæ‰€æœ‰åŠŸèƒ½æ¨¡å—ã€‚

### 2. ç”¨æˆ·æ¨¡å— (UserModule)

```typescript
// src/user/user.module.ts
@Module({
  imports: [TypeOrmModule.forFeature([User])],
  controllers: [UserController],
  providers: [UserService],
  exports: [UserService],  // è®©å…¶ä»–æ¨¡å—å¯ä»¥ä½¿ç”¨UserService
})
export class UserModule {}
```

**æ¨¡å—èŒè´£**ï¼š
- ğŸ¯ **å•ä¸€èŒè´£**ï¼šåªå¤„ç†ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡
- ğŸ”’ **å°è£…æ€§**ï¼šå†…éƒ¨å®ç°ç»†èŠ‚å¯¹å¤–ä¸å¯è§
- ğŸ”Œ **å¯æ’æ‹”**ï¼šå¯ä»¥è½»æ¾ç§»é™¤æˆ–æ›¿æ¢

### 3. æ–‡ç« æ¨¡å— (ArticleModule)

```typescript
// src/article/article.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([Article, User])  // éœ€è¦Userå®ä½“æ¥å»ºç«‹å…³è”
  ],
  controllers: [ArticleController],
  providers: [ArticleService],
  exports: [ArticleService],
})
export class ArticleModule {}
```

**ä¾èµ–å…³ç³»**ï¼š
- æ–‡ç« æ¨¡å—ä¾èµ–ç”¨æˆ·æ¨¡å—ï¼ˆæ–‡ç« éœ€è¦ä½œè€…ä¿¡æ¯ï¼‰
- é€šè¿‡ `imports` å£°æ˜ä¾èµ–å…³ç³»

## ğŸ” æ·±å…¥ç†è§£æ¨¡å—çš„ç»„æˆéƒ¨åˆ†

### Controllersï¼ˆæ§åˆ¶å™¨ï¼‰
**å‰ç«¯ç±»æ¯”**ï¼šè·¯ç”±å¤„ç†å‡½æ•°

```typescript
// å‰ç«¯è·¯ç”±ï¼ˆReact Routerï¼‰
function UserRoute() {
  return (
    <Routes>
      <Route path="/users" element={<UserList />} />
      <Route path="/users/:id" element={<UserDetail />} />
    </Routes>
  );
}
```

```typescript
// åç«¯æ§åˆ¶å™¨
@Controller('users')
export class UserController {
  @Get()
  findAll() {
    return this.userService.findAll();
  }
  
  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.userService.findOne(+id);
  }
}
```

### Servicesï¼ˆæœåŠ¡ï¼‰
**å‰ç«¯ç±»æ¯”**ï¼šè‡ªå®šä¹‰Hooksæˆ–å·¥å…·å‡½æ•°

```typescript
// å‰ç«¯è‡ªå®šä¹‰Hook
function useUser(userId) {
  const [user, setUser] = useState(null);
  
  const fetchUser = useCallback(async () => {
    const userData = await api.getUser(userId);
    setUser(userData);
  }, [userId]);
  
  return { user, fetchUser };
}
```

```typescript
// åç«¯æœåŠ¡
@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>,
  ) {}
  
  async findOne(id: number): Promise<User> {
    return this.userRepository.findOne({ where: { id } });
  }
}
```

### Providersï¼ˆæä¾›è€…ï¼‰
**å‰ç«¯ç±»æ¯”**ï¼šContext Provider

```typescript
// å‰ç«¯Context
const UserContext = createContext();

function UserProvider({ children }) {
  const [users, setUsers] = useState([]);
  
  return (
    <UserContext.Provider value={{ users, setUsers }}>
      {children}
    </UserContext.Provider>
  );
}
```

```typescript
// åç«¯Providerï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼‰
@Module({
  providers: [
    UserService,           // ç±»æä¾›è€…
    {
      provide: 'CONFIG',   // å€¼æä¾›è€…
      useValue: config,
    },
    {
      provide: 'LOGGER',   // å·¥å‚æä¾›è€…
      useFactory: () => new Logger(),
    }
  ],
})
```

## ğŸ¤– ä¾èµ–æ³¨å…¥çš„é­”æ³•

### å‰ç«¯çš„æ‰‹åŠ¨ä¾èµ–ç®¡ç†

```typescript
// å‰ç«¯éœ€è¦æ‰‹åŠ¨ä¼ é€’ä¾èµ–
function UserProfile({ userId, userService }) {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    userService.getUser(userId).then(setUser);
  }, [userId, userService]);
  
  return <div>{user?.name}</div>;
}

// ä½¿ç”¨æ—¶éœ€è¦æ‰‹åŠ¨ä¼ é€’
<UserProfile userId={1} userService={new UserService()} />
```

### åç«¯çš„è‡ªåŠ¨ä¾èµ–æ³¨å…¥

```typescript
// åç«¯è‡ªåŠ¨æ³¨å…¥ä¾èµ–
@Controller('users')
export class UserController {
  constructor(
    private userService: UserService  // è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»º
  ) {}
  
  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.userService.findOne(+id);  // ç›´æ¥ä½¿ç”¨
  }
}
```

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| æ–¹å¼ | å‰ç«¯æ‰‹åŠ¨ç®¡ç† | åç«¯è‡ªåŠ¨æ³¨å…¥ |
|------|-------------|-------------|
| åˆ›å»ºå®ä¾‹ | éœ€è¦æ‰‹åŠ¨new | æ¡†æ¶è‡ªåŠ¨åˆ›å»º |
| ç”Ÿå‘½å‘¨æœŸ | æ‰‹åŠ¨ç®¡ç† | æ¡†æ¶ç®¡ç† |
| æµ‹è¯•æ›¿æ¢ | å¤æ‚ | ç®€å• |
| ç±»å‹å®‰å…¨ | ä¸€èˆ¬ | å¼ºç±»å‹ |

## ğŸŒŸ æ¨¡å—åŒ–çš„æœ€ä½³å®è·µ

### 1. å•ä¸€èŒè´£åŸåˆ™

```typescript
// âŒ é”™è¯¯ï¼šä¸€ä¸ªæ¨¡å—ç®¡ç†å¤ªå¤šèŒè´£
@Module({
  controllers: [UserController, ArticleController, CommentController],
  providers: [UserService, ArticleService, CommentService],
})
export class MegaModule {}

// âœ… æ­£ç¡®ï¼šæ¯ä¸ªæ¨¡å—åªç®¡ç†ä¸€ä¸ªä¸šåŠ¡åŸŸ
@Module({
  controllers: [UserController],
  providers: [UserService],
})
export class UserModule {}

@Module({
  controllers: [ArticleController],
  providers: [ArticleService],
})
export class ArticleModule {}
```

### 2. ä¾èµ–æ–¹å‘

```typescript
// âœ… æ­£ç¡®çš„ä¾èµ–æ–¹å‘
AppModule
â”œâ”€â”€ UserModule
â”œâ”€â”€ ArticleModule (depends on User)
â””â”€â”€ CommentModule (depends on User, Article)

// âŒ é”™è¯¯ï¼šå¾ªç¯ä¾èµ–
UserModule â†â†’ ArticleModule  // äº’ç›¸ä¾èµ–ï¼Œä¼šå¯¼è‡´é—®é¢˜
```

### 3. åˆç†çš„å¯¼å‡º

```typescript
// âœ… åªå¯¼å‡ºå¿…è¦çš„æœåŠ¡
@Module({
  providers: [UserService, UserInternalService],
  exports: [UserService],  // åªå¯¼å‡ºå¯¹å¤–æ¥å£
})
export class UserModule {}
```

## ğŸ”§ å®æˆ˜ï¼šæ·»åŠ æ–°æ¨¡å—

å‡è®¾æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªè¯„è®ºæ¨¡å—ï¼š

### 1. åˆ›å»ºæ¨¡å—æ–‡ä»¶ç»“æ„

```
src/comment/
â”œâ”€â”€ comment.module.ts
â”œâ”€â”€ comment.controller.ts
â”œâ”€â”€ comment.service.ts
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ comment.entity.ts
â””â”€â”€ dto/
    â”œâ”€â”€ create-comment.dto.ts
    â””â”€â”€ comment-response.dto.ts
```

### 2. å®šä¹‰å®ä½“

```typescript
// comment.entity.ts
@Entity('blog_comments')
export class Comment {
  @PrimaryGeneratedColumn()
  id: number;
  
  @Column()
  content: string;
  
  @ManyToOne(() => User)
  author: User;
  
  @ManyToOne(() => Article)
  article: Article;
}
```

### 3. åˆ›å»ºæ¨¡å—

```typescript
// comment.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([Comment, User, Article])
  ],
  controllers: [CommentController],
  providers: [CommentService],
  exports: [CommentService],
})
export class CommentModule {}
```

### 4. æ³¨å†Œåˆ°æ ¹æ¨¡å—

```typescript
// app.module.ts
@Module({
  imports: [
    // ... å…¶ä»–æ¨¡å—
    CommentModule,  // æ·»åŠ æ–°æ¨¡å—
  ],
})
export class AppModule {}
```

## ğŸ“ å­¦ä¹ è¦ç‚¹æ€»ç»“

1. **æ¨¡å— = åŠŸèƒ½è¾¹ç•Œ**ï¼šæ¯ä¸ªæ¨¡å—è´Ÿè´£ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡åŠŸèƒ½
2. **ä¾èµ–æ³¨å…¥ = è‡ªåŠ¨åŒ–**ï¼šæ¡†æ¶å¸®ä½ ç®¡ç†å¯¹è±¡çš„åˆ›å»ºå’Œç”Ÿå‘½å‘¨æœŸ
3. **å¯¼å…¥å¯¼å‡º = æ¥å£è®¾è®¡**ï¼šæ˜ç¡®æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»
4. **æ§åˆ¶å™¨ = APIå…¥å£**ï¼šå¤„ç†HTTPè¯·æ±‚ï¼Œç±»ä¼¼å‰ç«¯çš„è·¯ç”±
5. **æœåŠ¡ = ä¸šåŠ¡é€»è¾‘**ï¼šå°è£…å…·ä½“çš„ä¸šåŠ¡å®ç°

## ğŸ”— ä¸å‰ç«¯çš„å¯¹åº”å…³ç³»

| åç«¯æ¦‚å¿µ | å‰ç«¯å¯¹åº” | è¯´æ˜ |
|---------|---------|------|
| Module | åŠŸèƒ½æ¨¡å—/é¡µé¢ | ç»„ç»‡ç›¸å…³åŠŸèƒ½ |
| Controller | Route Handler | å¤„ç†è¯·æ±‚ |
| Service | Custom Hook/Utils | ä¸šåŠ¡é€»è¾‘ |
| Entity | Model/Interface | æ•°æ®ç»“æ„ |
| DTO | API Types | æ•°æ®ä¼ è¾“æ ¼å¼ |

æŒæ¡äº†è¿™äº›æ¦‚å¿µï¼Œä½ å°±ç†è§£äº†åç«¯æ¨¡å—åŒ–çš„æ ¸å¿ƒæ€æƒ³ï¼ 